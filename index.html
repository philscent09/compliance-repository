<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facilities Management Group Government Compliance Repository</title>
    <style>
        /* --- FONT IMPORT --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* --- CSS VARIABLES (COLOR PALETTE & SIZING) --- */
        :root {
            /* Light Mode Colors */
            --font-family-sans: 'Inter', sans-serif;
            --color-primary: #4A5568;     /* Slate 600 */
            --color-primary-hover: #2D3748; /* Slate 800 */
            --color-secondary: #0d9488;    /* Teal 600 */
            --color-secondary-hover: #0f766e; /* Teal 700 */

            --color-background: #F8FAFC; /* Slate 50 */
            --color-surface: #FFFFFF;    /* White */
            --color-border: #E2E8F0;     /* Slate 200 */
            --color-table-header-bg: #F9FAFB;

            --color-text-primary: #1E293B;  /* Slate 800 */
            --color-text-secondary: #64748B;/* Slate 500 */
            --color-text-white: #FFFFFF;

            /* Status Colors */
            --color-success: #16A34A;
            --color-success-bg: #F0FDF4;
            --color-warning: #D97706;
            --color-warning-bg: #FFFBEB;
            --color-danger: #DC2626;
            --color-danger-bg: #FEF2F2;
            --color-info: #3B82F6;
            --color-info-bg: #EFF6FF;

            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 0.5rem;
        }

        /* Dark Mode Colors */
        [data-theme="dark"] {
            --color-primary: #94A3B8;
            --color-primary-hover: #64748B;
            --color-secondary: #14B8A6;
            --color-secondary-hover: #0D9488;

            --color-background: #0F172A; /* Slate 900 */
            --color-surface: #1E293B;    /* Slate 800 */
            --color-border: #334155;     /* Slate 700 */
            --color-table-header-bg: #111827;

            --color-text-primary: #F8FAFC; /* Slate 50 */
            --color-text-secondary: #94A3B8;/* Slate 400 */
            --color-text-white: #1E293B;
            
            --color-success-bg: #064E3B;
            --color-warning-bg: #78350F;
            --color-danger-bg: #7F1D1D;
            --color-info-bg: #1E40AF;
        }
        
        /* --- FMG Logo Style --- */
        .logo-fmg {
            position: absolute;
            top: 0.75rem; /* Aligned top with theme switcher */
            left: 50%; /* Centered horizontally */
            transform: translateX(-50%); /* Fine-tune centering */
            font-family: var(--font-family-sans);
            font-size: 1.75rem; /* Increased font size */
            font-weight: 700;
            color: #FF8C00;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            z-index: 10;
        }

        @media (max-width: 768px) {
            .logo-fmg {
                position: static;
                display: block;
                text-align: center;
                margin-top: 1rem;
            }
        }

        /* --- Theme Switcher Button --- */
        .theme-switcher {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            background-color: var(--color-primary);
            color: var(--color-text-white);
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            transition: background-color 0.3s, color 0.3s;
            position: absolute;
            top: 0.5rem; 
            right: 2.5rem; /* Aligned with main container padding */
        }

        .theme-switcher:hover {
            background-color: var(--color-primary-hover);
        }

        .theme-switcher svg {
            width: 20px;
            height: 20px;
            color: var(--color-text-white);
        }

        .theme-switcher .theme-label {
            font-weight: 600;
        }

        [data-theme="dark"] .theme-switcher {
            background-color: var(--color-surface);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
        }

        [data-theme="dark"] .theme-switcher:hover {
            background-color: var(--color-background);
        }
        [data-theme="dark"] .theme-switcher svg {
            color: var(--color-text-primary);
        }

        /* --- GENERAL STYLES & RESETS --- */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: var(--font-family-sans);
            background-color: var(--color-background);
            color: var(--color-text-primary);
            padding: 2rem;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- LAYOUT CONTAINERS --- */
        .main-container {
            width: 100%;
            max-width: 1600px; /* Increased max-width */
            margin: 0 auto;
            background-color: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 2.5rem;
            position: relative;
            transition: background-color 0.3s;
        }

        .header-title-wrapper {
            text-align: center;
            margin-bottom: 2.5rem;
            background-color: var(--color-primary);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            position: relative;
            margin-top: 1.5rem;
            transition: background-color 0.3s;
        }

        h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--color-text-white);
            line-height: 1.2;
            transition: color 0.3s;
        }

        .documents-section {
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: border-color 0.3s;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--color-border);
            transition: border-color 0.3s;
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
            transition: color 0.3s;
        }
        
        /* --- NOTIFICATIONS & ALERTS --- */
        .notifications-panel, .error-display {
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            border-width: 1px;
            border-style: solid;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .notifications-panel {
            background-color: var(--color-info-bg);
            border-color: var(--color-info);
            color: var(--color-info);
        }
        .notifications-panel ul {
            list-style-position: inside;
            padding-left: 0;
        }
        .notifications-panel h2 {
            border-bottom: none;
            margin-bottom: 0.5rem;
            color: var(--color-text-primary);
        }
        .notifications-panel li .text-red-700 { color: var(--color-danger); }
        .notifications-panel li .text-custom-green-teal { color: var(--color-warning); }
        .error-display {
            display: none;
            background-color: var(--color-danger-bg);
            border-color: var(--color-danger);
            color: var(--color-danger);
        }
		.notifications-panel li.clickable {
            cursor: pointer;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .notifications-panel li.clickable:hover {
            background-color: rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .notifications-panel li.clickable:hover {
             background-color: rgba(255,255,255,0.05);
        }
		
        .error-display.active { display: block; }
		
		/* --- Compliance Dashboard --- */
        .compliance-dashboard {
            padding-bottom: 1.5rem;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            align-items: center;
        }
        .donut-chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .donut-chart {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            position: relative;
            background: conic-gradient(var(--color-success) 0deg, var(--color-border) 0deg);
            transition: background 0.5s;
        }
        .donut-chart-center {
            width: 150px;
            height: 150px;
            background: var(--color-surface);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        #donut-chart-percent {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-text-primary);
        }
        #donut-chart-label {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
        }
        .donut-chart-ratio {
            margin-top: 1rem;
            font-weight: 600;
            color: var(--color-text-secondary);
        }
        .location-grid-container {
            width: 100%;
        }
        .sorting-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .sorting-controls span {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-secondary);
        }
        .sorting-controls button {
            background-color: var(--color-surface);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            padding: 0.35rem 0.75rem;
            font-size: 0.75rem;
        }
        .sorting-controls button:hover {
            background-color: var(--color-background);
        }
        .sorting-controls button.active {
            background-color: var(--color-primary);
            color: var(--color-text-white);
            border-color: var(--color-primary);
        }
        .location-progress-bars {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        .progress-bar-container, .location-progress-bar {
            margin-bottom: 1rem;
            cursor: pointer;
        }
        .progress-bar-label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--color-text-secondary); /* Set the default color to grey */
        }
        .progress-bar-label span:first-child {
            color: var(--color-text-primary); /* Set the location name back to the primary color */
        }
        .progress-bar-label span:last-child {
            font-size: 1rem;
            /* This color is now inherited correctly from the parent */
        }
        .progress-bar {
            position: relative;
            width: 100%;
            height: 24px;
            background-color: var(--color-border);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            border-radius: var(--border-radius);
            transition: width 0.5s ease-in-out, background-color 0.5s ease-in-out;
        }
        .progress-bar-inner.status-high { background-color: var(--color-success); }
        .progress-bar-inner.status-medium { background-color: #FBBF24; }
        .progress-bar-inner.status-low { background-color: var(--color-danger); }
        .progress-bar-text {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 2;
            color: var(--color-text-primary); /* Uses black in light mode, white in dark mode */
        }
		
		.status-medium + .progress-bar-text {
            color: var(--color-text-dark); /* Always use dark text on the yellow bar */
        }

        /* Responsive stacking for dashboard */
        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .location-progress-bars {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
		
		 /* --- Compliance Details Modal --- */
        #complianceDetailsModal .modal-content {
            max-width: 900px;
        }
        #complianceDetailsModal .compliance-lists {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 1.5rem;
        }
        #complianceDetailsModal .compliance-list h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        #complianceDetailsModal .compliance-list ul {
            list-style-type: none;
            padding-left: 0;
            max-height: 200px;
            overflow-y: auto;
        }
        #complianceDetailsModal .compliance-list li {
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        #complianceDetailsModal .compliance-list li:nth-child(odd) {
            background-color: var(--color-background);
        }
        #complianceDetailsModal .compliance-list li[data-doc-id],
        #complianceDetailsModal .compliance-list li[data-doc-name] {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #complianceDetailsModal .compliance-list li[data-doc-id]:hover,
        #complianceDetailsModal .compliance-list li[data-doc-name]:hover {
            background-color: var(--color-info-bg);
        }
        #complianceDetailsModal .compliance-sub-heading {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px dashed var(--color-border);
        }
        #complianceDetailsModal .compliance-lists > .compliance-list:last-child {
            border-left: 1px solid var(--color-border);
            padding-left: 2rem;
        }

        /* Responsive stacking for the modal on smaller screens */
        @media (max-width: 768px) {
            #complianceDetailsModal .compliance-lists {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            #complianceDetailsModal .compliance-lists > .compliance-list:last-child {
                border-left: none;
                padding-left: 0;
                padding-top: 1.5rem;
                border-top: 1px solid var(--color-border);
            }
        }

        /* --- FORMS, BUTTONS, & INTERACTIVE ELEMENTS --- */
        .location-add-section {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            background-color: #F9FAFB; /* A slightly off-white */
            margin-bottom: 2rem;
            transition: background-color 0.3s;
        }
        [data-theme="dark"] .location-add-section {
            background-color: #1F2937;
        }
        .location-add-section .location-selector { flex-grow: 1; }

        label {
            display: block;
            font-weight: 500;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--color-text-primary);
            transition: color 0.3s;
        }

        select, input[type="text"], input[type="date"], input[type="file"], textarea {
            width: 100%;
            padding: 0.65rem 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 0.375rem;
            background-color: var(--color-surface);
            color: var(--color-text-primary);
            box-shadow: var(--shadow-sm);
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s;
        }
        select:focus, input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(74, 85, 104, 0.2);
        }
        [data-theme="dark"] select:focus, [data-theme="dark"] input:focus {
             box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.2);
        }

        .action-buttons-group { display: flex; gap: 0.5rem; }

        button {
            padding: 0.65rem 1.5rem;
            border-radius: 0.375rem;
            border: none;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--color-text-white);
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: var(--shadow-sm);
        }
        button:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        button:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #addDocumentBtn, #generateReportBtn, #generateFullReportBtn { background-color: var(--color-primary); }
        #addDocumentBtn:hover, #generateReportBtn:hover, #generateFullReportBtn:hover { background-color: var(--color-primary-hover); }

        #renewDocumentBtn, #renew-confirm, #renew-confirm-form { background-color: var(--color-secondary); }
        #renewDocumentBtn:hover, #renew-confirm:not(:disabled):hover, #renew-confirm-form:hover { background-color: var(--color-secondary-hover); }
		
		#actionViewStatusBtn { background-color: var(--color-primary); }
        #actionViewStatusBtn:hover { background-color: var(--color-primary-hover); }

        #actionRenewBtn { background-color: var(--color-secondary); }
        #actionRenewBtn:hover { background-color: var(--color-secondary-hover); }
        
        /* This applies to all buttons with class "toggle-button" */
        .toggle-button {
            background-color: var(--color-text-secondary);
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
            display: flex; /* Added for consistent internal layout */
            align-items: center; /* Added for consistent internal layout */
            gap: 0.5rem; /* Added for consistent internal layout */
        }

        /* Filter Controls */
        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .filter-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            background-color: #F9FAFB;
            padding: 1rem;
            border-radius: var(--border-radius);
            transition: background-color 0.3s;
        }
        [data-theme="dark"] .filter-group {
            background-color: #1F2937;
        }
        .filter-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            margin-bottom: 0;
        }

        .text-filter-group {
            display: flex;
            gap: 1.5rem;
            background-color: #F9FAFB;
            padding: 1rem;
            border-radius: var(--border-radius);
            transition: background-color 0.3s;
        }
        [data-theme="dark"] .text-filter-group {
            background-color: #1F2937;
        }
        .text-filter-group input {
            flex-grow: 1;
        }

        /* --- TABLE STYLES --- */
        .table-container { 
            overflow-x: auto;
            max-height: 400px; /* Default max height for scroll */
            overflow-y: auto; /* Enable vertical scroll if content exceeds max-height */
            transition: opacity 0.3s ease, max-height 0.3s ease;
            opacity: 1;
        }
        .table-container.hidden {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        
        .documents-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        .documents-table th, .documents-table td {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap; /* Prevent wrapping for better horizontal visibility */
        }
        .documents-table th {
            font-size: 0.875rem; /* Increased font size */
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-secondary);
            background-color: var(--color-table-header-bg);
            transition: color 0.3s, background-color 0.3s;
            position: sticky; /* Make headers sticky */
            top: 0; /* Stick to the top of the scroll container */
            z-index: 1; /* Ensure headers are above scrolling content */
        }
        .documents-table td {
            font-size: 0.875rem; /* Increased font size matching header */
        }
        .documents-table tbody tr:hover { background-color: var(--color-background); }
        .documents-table tbody tr.row-expired { background-color: #ffc7c7; }
        .documents-table tbody tr.row-expiring { background-color: #faf89d; }
        
        @keyframes row-highlight {
            from { background-color: var(--color-warning-bg); }
            to { background-color: transparent; }
        }
        .documents-table tbody tr.row-highlight {
            animation: row-highlight 2.5s ease-out forwards;
        }

        [data-theme="dark"] .documents-table tbody tr.row-expired { background-color: #5c1f1f; }
        [data-theme="dark"] .documents-table tbody tr.row-expiring { background-color: #6b661d; }
        
        /* Table Sorting Headers */
        .sort-header {
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        .sort-icon {
            display: inline-block;
            width: 0.5rem;
            height: 0.5rem;
            margin-left: 0.5rem;
            border-left: 1px solid var(--color-text-secondary);
            border-bottom: 1px solid var(--color-text-secondary);
            transform: rotate(135deg);
            transition: transform 0.2s ease-in-out;
            opacity: 0.5;
        }
        .sort-header:hover .sort-icon { opacity: 1; }
        .sort-asc .sort-icon {
            transform: rotate(-45deg);
            opacity: 1;
        }
        .sort-desc .sort-icon {
            transform: rotate(135deg);
            opacity: 1;
        }

        /* Table Status Pills */
        .status-span {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-span.success { background-color: var(--color-success-bg); color: var(--color-success); }
        .status-span.warning { background-color: var(--color-warning-bg); color: var(--color-warning); }
        .status-span.danger { background-color: var(--color-danger-bg); color: var(--color-danger); }

        /* Table Action Buttons */
        .actions-cell { display: flex; align-items: center; gap: 0.5rem; }
        .action-button {
            display: flex;
            padding: 0.5rem;
            border-radius: 9999px;
            color: var(--color-text-white);
        }
        .action-button svg { height: 1rem; width: 1rem; }
        .download-btn { background-color: var(--color-info); }
        .edit-button-icon { background-color: var(--color-text-secondary); }
        .delete-button-icon { background-color: var(--color-danger); }
        .attachment-indicator { 
            color: var(--color-text-secondary);
            cursor: pointer; /* Indicate it's clickable for preview */
        }
        .attachment-indicator svg {
            width: 1.2rem;
            height: 1.2rem;
        }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active { display: flex; opacity: 1; }
		
		.modal-on-top {
            z-index: 101; /* Higher than the default 100 */
        }

        .modal-content {
            background-color: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease, background-color 0.3s;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }

        .modal-title {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 2rem;
            text-align: center;
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem; right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .modal-form .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }
        .modal-form .grid-span-2 { grid-column: span 2 / span 2; }
        .modal-form .flex-justify-between {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            grid-column: span 2 / span 2;
        }
        .modal-form button[type="submit"] { background-color: var(--color-primary); }
        .modal-form button[type="button"] {
            background-color: var(--color-border);
            color: var(--color-text-primary);
        }
        .modal-form .text-red-500 { color: var(--color-danger); font-size: 0.8rem; }
        
        /* Utility */
        .hidden { display: none !important; }
    
        #deleteAttachmentBtn {
            background-color: var(--color-danger);
            color: #fff;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
            cursor: pointer;
        }
        #deleteAttachmentBtn svg {
            width: 0.9rem;
            height: 0.9rem;
        }
        #deleteAttachmentBtn:hover:not(:disabled) {
            background-color: var(--color-danger-hover);
        }
        
        /* Make delete button circular to match edit/download */
        .action-button.delete-button-icon {
            border-radius: 50%;
            width: 2.2rem;
            height: 2.2rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .action-button.delete-button-icon svg {
            width: 1rem;
            height: 1rem;
        }
    
        /* Delete Attachment Buttons (Option C style: small red text + icon) */
        #deleteAttachmentBtn,
        #renewDeleteAttachmentBtn {
            background: none;
            border: none;
            color: var(--color-danger);
            font-size: 0.7rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        #deleteAttachmentBtn svg,
        #renewDeleteAttachmentBtn svg {
            width: 0.8rem;
            height: 0.8rem;
        }
        #deleteAttachmentBtn:hover,
        #renewDeleteAttachmentBtn:hover {
            text-decoration: underline;
        }
        /* Disabled action buttons */
        

        /* --- About / Version Info Panel Styles --- */
        .collapsible-panel .section-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-right: 1rem; /* For the arrow icon */
        }
        .collapsible-panel .section-header h2 {
            margin-bottom: 0;
        }
        .collapsible-panel .toggle-button svg {
            transition: transform 0.3s ease;
        }
        .collapsible-panel .toggle-button.rotated svg {
            transform: rotate(180deg);
        }
        .collapsible-content {
            overflow-y: hidden; 
            max-height: 0;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }
        .collapsible-content.expanded {
            max-height: 500px; /* Adjust as needed based on content height */
            overflow-y: auto; /* Enable scroll for expanded content */
            opacity: 1;
        }

        /* --- Timeline Table Styles --- */
        .timeline-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            position: relative;
        }

        .timeline-table::before {
            content: '';
            position: absolute;
            left: 50%; /* Center the line */
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--color-border);
            z-index: 0;
            transform: translateX(-50%);
        }

        .timeline-table th, .timeline-table td {
            padding: 0.8rem 1rem;
            border-bottom: 1px dashed var(--color-border); /* Dashed line for subtle separation */
        }
        .timeline-table tbody tr:last-child td {
            border-bottom: none;
        }

        .timeline-table th {
            text-align: center; /* Center headers */
            font-size: 0.9rem; /* Increased font size */
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--color-text-secondary);
            background-color: var(--color-table-header-bg); /* Changed from transparent to solid background */
            position: sticky;
            top: 0;
            z-index: 2; /* Increased z-index to ensure it stays above the timeline circles */
        }
        .timeline-table td {
            font-size: 0.9rem; /* Increased font size matching header */
        }
        
        [data-theme="dark"] .timeline-table th {
            background-color: var(--color-table-header-bg); /* Ensure solid background in dark mode too */
        }


        .timeline-table td {
            vertical-align: top;
            position: relative;
        }
        
        .timeline-date-cell {
            font-weight: 600;
            color: var(--color-text-primary);
            width: 45%; /* Date on left */
            text-align: right;
            padding-right: 2rem;
        }

        .timeline-description-cell {
            width: 45%; /* Description on right */
            padding-left: 2rem;
            text-align: left;
        }

        .timeline-middle-cell {
            width: 10%;
            position: relative;
            text-align: center;
        }

        .timeline-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background-color: var(--color-primary); /* Circle color */
            border-radius: 50%;
            border: 2px solid var(--color-surface); /* Border to stand out */
            z-index: 1; /* Keep z-index lower than sticky header */
            box-shadow: 0 0 0 2px var(--color-primary); /* Subtle glow */
        }
        
        [data-theme="dark"] .timeline-circle {
            border: 2px solid var(--color-background);
            box-shadow: 0 0 0 2px var(--color-secondary);
        }

        @media (max-width: 768px) {
            .timeline-table::before {
                left: 20px; /* Align timeline line to the left for mobile */
                transform: translateX(0);
            }
            .timeline-date-cell, .timeline-description-cell {
                width: auto;
                text-align: left;
                padding-left: 50px; /* Space for the timeline line and circles */
                padding-right: 0;
            }
            .timeline-middle-cell {
                display: none; /* Hide middle cell on mobile, use ::before on description */
            }
            .timeline-table td {
                display: block;
                width: 100%;
                box-sizing: border-box;
                border-bottom: none; /* No horizontal line between date/desc */
            }
            .timeline-table tr {
                display: block;
                margin-bottom: 1rem;
                border-bottom: 1px solid var(--color-border); /* Separator between entries */
            }
            .timeline-table tr:last-child {
                border-bottom: none;
            }

            .timeline-table td.timeline-description-cell::before {
                content: '';
                position: absolute;
                left: 15px; /* Adjust for padding and line */
                top: 15px;
                transform: translateY(-50%);
                width: 16px;
                height: 16px;
                background-color: var(--color-primary);
                border-radius: 50%;
                border: 2px solid var(--color-surface);
                z-index: 1;
                box-shadow: 0 0 0 2px var(--color-primary);
            }
            [data-theme="dark"] .timeline-table td.timeline-description-cell::before {
                border: 2px solid var(--color-background);
                box-shadow: 0 0 0 2px var(--color-secondary);
            }
             .timeline-table td.timeline-date-cell {
                font-size: 0.9em;
                color: var(--color-text-secondary);
                margin-bottom: 0.25em;
             }
        }

        /* --- Preview Modal Specific Styles --- */
        #previewModal .modal-content {
            max-width: 90%;
            width: 100%;
            height: 90%;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #previewModal .modal-title {
            margin-bottom: 1rem;
            font-size: 1.25rem;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.5rem;
            width: 100%;
            text-align: center;
        }

        #previewContent {
            flex-grow: 1;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; /* Important for scaling */
            position: relative;
        }

        #previewContent iframe, #previewContent img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border: 1px solid var(--color-border);
            background-color: #f0f0f0;
            transition: transform 0.2s ease-in-out;
            transform-origin: center center;
        }

        #previewContent iframe {
            width: 100%;
            height: 100%;
        }

        #previewControls {
            margin-top: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        #previewControls button {
            background-color: var(--color-secondary);
            color: var(--color-text-white);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #previewControls button:hover {
            background-color: var(--color-secondary-hover);
        }
		.modal-footer {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: flex-end;
        }
		
		.agency-cell-flex {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
            /* The following ensures vertical alignment is consistent with other cells */
            justify-content: center;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        .renewal-status-button {
            background-color: var(--color-secondary);
            color: var(--color-text-white);
            border: none;
            border-radius: 9999px; /* Pill shape */
            padding: 0.25rem 0.75rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .renewal-status-button:hover {
            background-color: var(--color-secondary-hover);
        }
        #statusLogModal .modal-content {
            max-width: 800px; /* Make the modal wider */
            height: 80%;
            max-height: 700px;
            display: flex;
            flex-direction: column;
        }
        .comment-history-container {
            flex-grow: 1; /* This makes the container take up available space */
            min-height: 150px; /* Ensures it has a minimum height */
            overflow-y: auto;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            margin-bottom: 1.5rem;
            background-color: var(--color-background);
        }
        .comment-history-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .comment-history-list li {
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
            border-bottom: 1px dashed var(--color-border);
        }
        .comment-history-list li:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .comment-history-list .comment-meta {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 0.25rem;
        }
        .comment-history-list .comment-text {
            font-size: 0.875rem;
            white-space: pre-wrap;
        }
        #newCommentForm #newCommentText {
            height: 120px; /* Sets a generous, fixed height */
            resize: none;  /* Makes the field static and not draggable */
        }
        }
		.dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
            align-items: center;
        }
        .donut-chart-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .donut-chart {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            position: relative;
            background: conic-gradient(var(--color-success) 0deg, var(--color-border) 0deg);
            transition: background 0.5s;
        }
        .donut-chart-center {
            width: 150px;
            height: 150px;
            background: var(--color-surface);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
         #donut-chart-percent {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-text-primary);
            text-shadow: 0 0 5px var(--color-surface); /* Adds a subtle glow for readability */
        }
        #donut-chart-label {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
        }
        .donut-chart-ratio {
            margin-top: 1rem;
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        /* Responsive stacking for dashboard */
        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .location-progress-bars {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="logo-fmg">Facilities Management Group</div>
        <button id="theme-switcher" class="theme-switcher" aria-label="Toggle dark mode">
            <div class="icon-wrapper">
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.95-4.243-1.59-1.59M3 12h2.25m.386-6.364 1.59 1.591M12 12a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0Z" />
                </svg>
                <svg id="moon-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25c0 5.385 4.365 9.75 9.75 9.75 2.572 0 4.92-.99 6.697-2.648Z" />
                </svg>
            </div>
            <span class="theme-label">Toggle dark mode</span>
        </button>
        
        <header class="header-title-wrapper">
            <h1>Government Compliance Repository</h1>
        </header>

        <div id="globalNotification" class="error-display" role="alert">
            <p id="notificationMessage"></p>
        </div>

        <section class="notifications-panel">
            <h2>Important Notifications</h2>
            <ul id="notificationsList" aria-live="polite"></ul>
        </section>

        <section class="documents-section compliance-dashboard">
            <div class="section-header">
                <h2>Compliance Status Dashboard</h2>
                <button id="generateFullReportBtn" aria-label="Generate Full Compliance Report">Generate Full Report</button>
            </div>
            <div class="dashboard-grid">
                <div class="donut-chart-container">
                    <div class="donut-chart" id="overall-donut-chart">
                        <div class="donut-chart-center">
                            <span id="donut-chart-percent">0%</span>
                            <span id="donut-chart-label">Overall Compliance</span>
                        </div>
                    </div>
                    <div id="donut-chart-ratio" class="donut-chart-ratio">0 / 0 docs</div>
                </div>
                <div class="location-grid-container">
                    <div class="sorting-controls" id="location-sorting-controls">
                        <span>Sort by:</span>
                        <button data-sort-by="compliance_desc" class="active">Compliance ↓</button>
                        <button data-sort-by="compliance_asc">Compliance ↑</button>
                        <button data-sort-by="name_asc">Name A-Z</button>
                    </div>
                    <div class="location-progress-bars">
                        </div>
                </div>
            </div>
        </section>

        <section class="documents-section" id="manage-documents-section">
            <div class="section-header">
                <h2>Manage Documents</h2>
            </div>
            <div class="location-add-section">
                <div class="location-selector">
                    <label for="location-select">Filter by Office Location</label>
                    <select id="location-select" aria-label="Select Office Location">
                        <option value="">All Locations</option>
                    </select>
                </div>
                <div class="action-buttons-group">
                     <button id="renewDocumentBtn" aria-label="Renew Existing Document">Renew Document</button>
                     <button id="addDocumentBtn" aria-label="Add New Document">Add New Document</button>
                </div>
            </div>

            <div class="filter-controls">
                <div class="filter-group">
                    <label><input type="radio" name="documentFilter" value="all" id="filter-all" checked> Show All</label>
                    <label><input type="radio" name="documentFilter" value="non-expiring" id="filter-non-expiring"> Active</label>
                    <label><input type="radio" name="documentFilter" value="expiring" id="filter-expiring"> Expiring/Expired</label>
                </div>
                <div class="text-filter-group">
                    <input type="text" id="filter-agency-name" placeholder="Filter by Agency..." />
                    <input type="text" id="filter-document-name" placeholder="Filter by Document..." />
                </div>
            </div>

            <div class="table-container">
                <table id="documentsTable" class="documents-table">
                    <thead>
                        <tr>
                            <th class="sort-header" data-sort-key="agencyName">Agency<span class="sort-icon"></span></th>
                            <th class="sort-header" data-sort-key="documentName">Document Name<span class="sort-icon"></span></th>
                            <th class="sort-header" data-sort-key="documentNumber">Doc Number<span class="sort-icon"></span></th>
                            <th class="sort-header" data-sort-key="issuanceDate">Issued<span class="sort-icon"></span></th>
                            <th class="sort-header" data-sort-key="expirationDate">Expires<span class="sort-icon"></span></th>
                            <th class="sort-header" data-sort-key="locationId">Location<span class="sort-icon"></span></th>
                            <th class="sort-header" data-sort-key="entityName">Entity Name<span class="sort-icon"></span></th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="documentsTableBody"></tbody>
                    <tfoot id="documentsTableFoot" class="hidden">
                        <tr>
                           <td colspan="9" style="text-align: center; padding: 2rem;">No documents match the current filters.</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>

        <section class="documents-section">
            <div class="section-header">
                  <h2>Archived Documents</h2>
                  <button id="toggleArchivedTableBtn" class="toggle-button">Show/Hide</button>
            </div>
            <div id="archived-table-content" class="hidden"> <div class="filter-controls">
                    <div class="filter-group">
                        <label for="filter-archived-location">Location:</label>
                        <select id="filter-archived-location" aria-label="Filter archived by location">
                            <option value="">All Locations</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-archived-year">Year:</label>
                        <select id="filter-archived-year" aria-label="Filter archived by year">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div class="text-filter-group"> <input type="text" id="filter-archived-agency" placeholder="Filter by Agency..." />
                        <input type="text" id="filter-archived-document" placeholder="Filter by Document..." />
                    </div>
                </div>
                <div class="table-container" id="archivedTableContainer">
                    <table id="archivedDocumentsTable" class="documents-table">
                        <thead>
                            <tr>
                                <th class="sort-header" data-sort-key="agencyName">Agency<span class="sort-icon"></span></th>
                                <th class="sort-header" data-sort-key="documentName">Document Name<span class="sort-icon"></span></th>
                                <th class="sort-header" data-sort-key="documentNumber">Doc Number<span class="sort-icon"></span></th>
                                <th class="sort-header" data-sort-key="issuanceDate">Issued<span class="sort-icon"></span></th>
                                <th class="sort-header" data-sort-key="expirationDate">Expiration Date<span class="sort-icon"></span></th>
                                <th class="sort-header" data-sort-key="locationId">Location<span class="sort-icon"></span></th>
                                <th class="sort-header" data-sort-key="entityName">Entity Name<span class="sort-icon"></span></th>
                                <th class="sort-header" data-sort-key="archivedAt">Archived At<span class="sort-icon"></span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="archivedDocumentsTableBody"></tbody>
                         <tfoot id="archivedTableFoot" class="hidden">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 2rem;">No archived documents match the current filters.</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </section>

        <section class="documents-section collapsible-panel">
            <div class="section-header" id="aboutPanelHeader" aria-expanded="false" aria-controls="aboutPanelContent" role="button" tabindex="0">
                <h2>About / Version Info</h2>
                <button id="toggleAboutPanelBtn" class="toggle-button" aria-label="Toggle About Panel">
                    <span>Show/Hide</span>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                    </svg>
                </button>
            </div>
            <div id="aboutPanelContent" class="collapsible-content"> <table class="timeline-table">
                    <thead>
                        <tr>
                            <th style="text-align: right;">Version / Date</th>
                            <th></th> <th style="text-align: left;">Changes</th>
                        </tr>
                    </thead>
                    <tbody>
						<tr>
                            <td class="timeline-date-cell"><strong>v19.0</strong><br>Aug 24, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Redesigned the Compliance Status Dashboard. Replaced the 'Overall Compliance' progress bar with a large, dynamic donut chart and rearranged the location-specific progress bars into a clean 2x2 grid for a more modern and readable layout.</td>
                        </tr>
						<tr>
                            <td class="timeline-date-cell"><strong>v18.9.2</strong><br>Aug 24, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Fixed a UI bug where modals opened from the 'Action For' notification pop-up would appear behind it. The newly opened modal now correctly appears on top.</td>
                        </tr>
						<tr>
                            <td class="timeline-date-cell"><strong>v18.9.1</strong><br>Aug 24, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Refined the notification workflow. The 'Action For' modal now remains open in the background, allowing users to perform multiple actions (like viewing status and then renewing) without having to re-click the original notification.</td>
                        </tr>
						<tr>
                            <td class="timeline-date-cell"><strong>v18.9</strong><br>Aug 24, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Made notifications in the dashboard interactive. Clicking a notification now opens a pop-up modal with direct shortcuts to either 'View Renewal Status' or 'Renew Document Now'.</td>
                        </tr>
						<tr>
                            <td class="timeline-date-cell"><strong>v18.8</strong><br>Aug 23, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Refined the UI of the 'Renewal Status Log' modal. The form for adding new entries now uses a cleaner, stacked layout with improved styling and a larger, non-resizable comment box for better usability.</td>
                        </tr>
						<tr>
                            <td class="timeline-date-cell"><strong>v18.7</strong><br>Aug 23, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Enhanced the Archived Documents table. A 'View Log' button now appears for archived documents that have a comment history, opening a read-only view of their renewal status log.</td>
                        </tr>
						<tr>
                            <td class="timeline-date-cell"><strong>v18.6</strong><br>Aug 23, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Added a Renewal Status Log feature. A prominent 'Renewal Status' button now appears under the agency name for expiring/expired documents, opening a dedicated modal to track renewal progress with timestamped comments.</td>
                        </tr>
						<tr>
                            <td class="timeline-date-cell"><strong>v18.5</strong><br>Aug 23, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Updated the Compliance Details modal to a wider, two-column landscape view on larger screens for better visibility, while retaining a stacked view on mobile for responsiveness.</td>
                        </tr>
						<tr>
                            <td class="timeline-date-cell"><strong>v18.4</strong><br>Aug 23, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Implemented a reporting feature. A global button generates a consolidated A4 PDF report for all locations, and a button within the details modal generates a report for a single location.</td>
                        </tr>
						<tr>
                            <td class="timeline-date-cell"><strong>v18.3</strong><br>Aug 23, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Added informative tooltips to the Compliance Dashboard. Hovering over a location's progress bar now displays a quick summary of compliant, lacking, expired, and expiring documents.</td>
                        </tr>
						<tr>
                            <td class="timeline-date-cell"><strong>v18.2</strong><br>Aug 23, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Added sorting controls to the Compliance Dashboard, allowing location progress bars to be ordered by compliance percentage or alphabetically by name.</td>
                        </tr>
						<tr>
                            <td class="timeline-date-cell"><strong>v18.1</strong><br>Aug 23, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Enhanced the Compliance Dashboard with dynamic, color-coded progress bars (red, yellow, green) to provide an at-a-glance status of each location's compliance level.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v18.0</strong><br>Aug 22, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Transformed the Compliance Details modal into an interactive control panel. Documents listed are now clickable shortcuts to find, add, or renew items, streamlining the compliance workflow.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v17.0.2</strong><br>Aug 22, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Refined the theme switcher button by using clearer sun/moon icons and shortening the text to "Light Mode" and "Dark Mode".</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v17.0.1</strong><br>Aug 22, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Modified the Compliance Dashboard progress bars to display the percentage text in a static position, preventing it from being hidden at low compliance levels.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v17.0</strong><br>Aug 22, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Implemented a "Smart" Compliance Dashboard. Progress bars now track compliance against a master list of required documents. Added a clickable pop-up modal to show detailed lists of compliant and lacking documents for each location.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v16.0</strong><br>Aug 22, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Added a new Compliance Status Dashboard section with dynamic progress bars for overall and location-specific compliance rates.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.8</strong><br>Aug 22, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Implemented a file size limit of 1.2 MB for attachments to prevent errors with `localStorage` and preview functionality. The app now displays a clear error message if a user attempts to upload a file that is too large.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.7</strong><br>Aug 22, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Fixed a bug in the "Renew Document" modal that incorrectly disabled the Document Number, Issuance/Expiration Dates, and attachment fields, preventing renewals. These fields are now editable as intended.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.6.3</strong><br>Aug 22, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Further increased logo font size for better visual balance with the theme switcher button.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.6.2</strong><br>Aug 22, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Aligned the Theme Switcher to the page edge and adjusted the main logo's vertical position to match.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.6.1</strong><br>Aug 22, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Increased the font size of the main logo for better visibility and visual balance.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.6</strong><br>Aug 22, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Centered the "Facilities Management Group" logo text on the main page while maintaining vertical alignment with the theme switcher.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.5 (Current Baseline)</strong><br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Reverted application to v15.5 as the new baseline and removed newer version history.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.5</strong><br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Simplified tooltips for active Edit/Delete buttons to "Edit Document" and "Delete Document".</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.4</strong><br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Restored specific tooltips for active Edit/Delete buttons while retaining disabled tooltips.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.3</strong><br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Modified tooltip for disabled action buttons to a concise "Disabled: Document is expiring/expired".</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.2</strong><br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Increased table text size in all tables (Manage, Archived, About/Version Info) for improved legibility.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.1</strong><br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Adjusted table text sizes, unified archived document filter layout, and set archived/about sections to be hidden by default.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v15.0</strong><br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Implemented renewal date validation, attachment preview with zoom & download, archived document filters (location, year), wider layout, and table scrolling.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v14.0.4</strong><br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Adjusted z-index of timeline table headers to prevent timeline dots from clipping through them when scrolling.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v14.0.3</strong><br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Fixed clipping issue in About / Version Info section by adding a solid background to sticky table headers. This also makes the scrollbar visually apply only to the changelog information.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v14.0.2</strong><br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Added scroll functionality to the About / Version Info panel for better viewing of changelog.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v14.0.1</strong><br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Modified "About / Version Info" toggle button to include "Show/Hide" text and refined its internal layout to align with "Archived Documents" toggle button styling.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell"><strong>v14.0</strong><br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Renamed file to v14.0 and updated version info.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell">v13.0<br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Added About / Version Info collapsible panel with styled changelog.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell">v12.2 (Improvement)<br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Modified "Delete" button behavior from archiving to permanently deleting documents. Updated confirmation pop-up message.</td>
                        </tr>
                         <tr>
                            <td class="timeline-date-cell">v12.2 (Improvement)<br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Changed "Remove" button in Delete Confirmation pop-up to red with white text, and "Cancel" button to black text.</td>
                        </tr>
                         <tr>
                            <td class="timeline-date-cell">v12.2 (Improvement)<br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Implemented conditional document name options and "Other" input field based on "Government Agency" selection.</td>
                        </tr>
                        <tr>
                            <td class="timeline-date-cell">v12.2 (Improvement)<br>Aug 21, 2025</td>
                            <td class="timeline-middle-cell"><div class="timeline-circle"></div></td>
                            <td class="timeline-description-cell">Changed "Cancel" button text styling to black in "Delete Attachment" window, applied to Add, Renew, and Edit windows.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <div id="documentModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <button id="closeModalBtn" class="modal-close-btn" aria-label="Close modal">&times;</button>
            <h2 id="modal-title" class="modal-title">Add New Document</h2>
            <form id="documentForm" class="modal-form" novalidate>
                 <input type="hidden" id="form-document-id" name="id">
                 <input type="hidden" id="form-attachment-data" name="attachmentData">
                 <input type="hidden" id="form-attachment-name" name="attachmentName">
                 <input type="hidden" id="original-expiration-date" name="originalExpirationDate"> <div class="form-grid">
                    <div class="grid-span-2">
                        <label for="form-agency-name">Government Agency</label>
                        <select id="form-agency-name" name="agencyName" required autofocus>
                            <option value="">Select an Agency</option>
                            <option value="City Mayor's Office">City Mayor's Office</option>
                            <option value="City Engineer's Office">City Engineer's Office</option>
                            <option value="City Health Office">City Health Office</option>
                            <option value="Barangay Office">Barangay Office</option>
                            <option value="Bureau of Fire & Protection (BFP)">Bureau of Fire & Protection (BFP)</option>
                            <option value="Department of Environment & Natural Resources (DENR)">Department of Environment & Natural Resources (DENR)</option>
                            <option value="Philippine Economic Zone Authority (PEZA)">Philippine Economic Zone Authority (PEZA)</option>
                            <option value="BFP Central Liaison Unit (BFP-CLU)">BFP Central Liaison Unit (BFP-CLU)</option>
                            <option value="Department of Labor & Employment (DOLE)">Department of Labor & Employment (DOLE)</option>
                            <option value="Department of Energy (DOE)">Department of Energy (DOE)</option>
                            <option value="International Organization for Standardization (ISO)">International Organization for Standardization (ISO)</option>
                            <option value="Laguna Lake Development Agency (LLDA)">Laguna Lake Development Agency (LLDA)</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="text" id="form-agency-name-other" name="agencyNameOther" class="hidden" placeholder="Please specify other agency" style="margin-top: 0.5rem;" />
                        <p id="agency-name-error" class="text-red-500 hidden"></p>
                    </div>
                    <div class="grid-span-2">
                        <label for="form-document-name">Document Name</label>
                        <select id="form-document-name" name="documentName" required></select>
                        <input type="text" id="form-document-name-other" name="documentNameOther" class="hidden" placeholder="Please specify other document name" style="margin-top: 0.5rem;" />
                        <p id="document-name-error" class="text-red-500 hidden"></p>
                    </div>
                    <div class="grid-span-2">
                        <label for="form-document-number">Document Number</label>
                        <input type="text" id="form-document-number" name="documentNumber" required />
                        <p id="document-number-error" class="text-red-500 hidden"></p>
                    </div>
                    <div>
                        <label for="form-issuance-date">Date of Issuance</label>
                        <input type="date" id="form-issuance-date" name="issuanceDate" required />
                        <p id="issuance-date-error" class="text-red-500 hidden"></p>
                    </div>
                    <div>
                        <label for="form-expiration-date">Date of Expiration</label>
                        <input type="date" id="form-expiration-date" name="expirationDate" required />
                        <label><input type="checkbox" id="oneTimeIssuanceCheckbox"> One-Time Issuance</label>
                        <p id="expiration-date-error" class="text-red-500 hidden"></p>
                        <p id="renewal-date-error" class="text-red-500 hidden"></p> </div>
                    <div class="grid-span-2">
                         <p id="date-order-error" class="text-red-500 hidden"></p>
                    </div>
                    <div class="grid-span-2">
                        <label for="form-upload-document">Upload Document:</label>
                        <input type="file" id="form-upload-document" name="uploadDocument" />
                        <p id="current-attachment" style="font-size: 0.8rem; font-style: italic; margin-top: 0.25rem;"></p>
                        <button type="button" id="deleteAttachmentBtn" class="hidden" title="Remove attached file">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:0.8rem;height:0.8rem;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 7h12M9 7V5a1 1 0 011-1h4a1 1 0 011 1v2m-7 0h8m-9 4v6m4-6v6m4-6v6M4 7h16l-1 12a2 2 0 01-2 2H7a2 2 0 01-2-2L4 7z"/>
                            </svg> Delete Attachment
                        </button>
                    </div>
                    <div class="grid-span-2">
                        <label for="form-location">Office Location</label>
                        <select id="form-location" name="formLocation" required>
                            <option value="">Select a location</option>
                        </select>
                        <p id="location-error" class="text-red-500 hidden"></p>
                    </div>
                    <div class="grid-span-2">
                        <label for="form-entity-name">Entity Name</label>
                        <select id="form-entity-name" name="entityName" required>
                            <option value="">Select an Entity</option>
                        </select>
                        <input type="text" id="form-entity-name-other" name="entityNameOther" class="hidden" placeholder="Please specify other entity" style="margin-top: 0.5rem;" />
                        <p id="entity-name-error" class="text-red-500 hidden"></p>
                    </div>
                    <div class="flex-justify-between">
                        <button type="button" id="cancelDocumentBtn">Cancel</button>
                        <button type="submit" id="saveDocumentBtn">Add Document</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="renewModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="renew-modal-title">
        <div class="modal-content">
             <button id="closeRenewModalBtn" class="modal-close-btn" aria-label="Close modal">&times;</button>
            <h2 id="renew-modal-title" class="modal-title">Renew a Document</h2>
            <div>
                <label for="renew-doc-select">Select a document to renew:</label>
                <select id="renew-doc-select">
                    <option value="">--Please choose an option--</option>
                </select>
                <p id="renew-location-info" style="font-size: 0.8rem; font-style: italic; margin-top: 0.25rem;"></p>
            </div>
            <div class="flex-justify-between" style="margin-top: 1.5rem;">
                <button type="button" id="renew-cancel">Cancel</button>
                <button type="button" id="renew-confirm" disabled>Renew Selected</button>
            </div>
        </div>
    </div>

    <div id="previewModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="preview-modal-title">
        <div class="modal-content">
            <button id="closePreviewModalBtn" class="modal-close-btn" aria-label="Close preview modal">&times;</button>
            <h2 id="preview-modal-title" class="modal-title">Document Preview</h2>
            <div id="previewContent">
                </div>
            <div id="previewControls">
                <button id="zoomOutBtn" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1.2rem;height:1.2rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15" /></svg> Zoom Out</button>
                <button id="zoomInBtn" class="hidden"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1.2rem;height:1.2rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg> Zoom In</button>
                <button id="downloadPreviewBtn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1.2rem;height:1.2rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg> Download</button>
            </div>
        </div>
    </div>

    <div id="complianceDetailsModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="compliance-modal-title">
        <div class="modal-content">
            <button id="closeComplianceModalBtn" class="modal-close-btn" aria-label="Close modal">&times;</button>
            <h2 id="compliance-modal-title" class="modal-title">Compliance Details</h2>
            <div class="compliance-lists">
                <div class="compliance-list">
                    <h3>Compliant Documents</h3>
                    <ul id="compliant-docs-list"></ul>
                </div>
                <div class="compliance-list">

                    <h3>Non-Compliant Documents</h3>
                    <h4 class="compliance-sub-heading">Lacking</h4>
                    <ul id="lacking-docs-list"></ul>
                    <h4 class="compliance-sub-heading">Expired</h4>
                    <ul id="expired-docs-list"></ul>
                    <h4 class="compliance-sub-heading">Expiring Soon</h4>
                    <ul id="expiring-docs-list"></ul>
					<div class="modal-footer">
                
				<button type="button" id="generateReportBtn">Generate Report</button>
           </div>
                </div>
            </div>
        </div>
    </div>
	
	<div id="statusLogModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="statusLogTitle">
        <div class="modal-content">
            <button id="closeStatusLogModalBtn" class="modal-close-btn" aria-label="Close modal">&times;</button>
            <h2 id="statusLogTitle" class="modal-title">Renewal Status Log</h2>
            <div class="comment-history-container">
                <ul id="commentHistoryList" class="comment-history-list">
                    </ul>
            </div>
            <form id="newCommentForm" class="modal-form" novalidate>
                <div class="form-grid" style="grid-template-columns: 1fr; gap: 1rem;">
                    <div class="grid-span-2">
                        <label for="newCommentText">New Log Entry / Status</label>
                        <textarea id="newCommentText" name="newCommentText" required></textarea>
                    </div>
                    <div class="grid-span-2">
                        <label for="newCommentor">Comment By</label>
                        <input type="text" id="newCommentor" name="newCommentor" required />
                    </div>
                </div>
                <div class="flex-justify-between" style="margin-top: 1rem;">
                    <button type="submit">Save Entry</button>
                </div>
            </form>
        </div>
    </div>
	
	<div id="notificationActionModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="notificationActionTitle">
        <div class="modal-content" style="max-width: 500px;">
            <button id="closeNotificationActionModalBtn" class="modal-close-btn" aria-label="Close modal">&times;</button>
            <h2 id="notificationActionTitle" class="modal-title">Action For:</h2>
            <div id="notificationActionContent" style="text-align: center; margin-bottom: 2rem;"></div>
            <div class="flex-justify-between" style="display: flex; justify-content: center; gap: 1rem;">
                <button type="button" id="actionViewStatusBtn">View Renewal Status</button>
                <button type="button" id="actionRenewBtn">Renew Document Now</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const LOCAL_STORAGE_KEY_DOCUMENTS = 'govDocsRepository_documents_v3';
            const LOCAL_STORAGE_KEY_ARCHIVES = 'govDocsRepository_archives_v3';
            const LOCAL_STORAGE_KEY_LOCATIONS = 'govDocsRepository_locations_v3';
            const LOCAL_STORAGE_KEY_THEME = 'govDocsRepository_theme';
            const LOCAL_STORAGE_KEY_ARCHIVE_VISIBILITY = 'govDocsRepository_archive_visibility';
            const LOCAL_STORAGE_KEY_ABOUT_PANEL_VISIBILITY = 'govDocsRepository_about_panel_visibility';
            const MAX_FILE_SIZE_MB = 1.2; // Set max file size in MB


            let documents = [];
            let archivedDocuments = [];
            let locations = [];
            let complianceDataCache = {};
            let docNameToAgencyMap = {}; // For pre-filling 'add' form

            let currentMainSortKey = null;
            let currentMainSortDirection = 'asc';
            let currentArchivedSortKey = null;
            let currentArchivedSortDirection = 'asc';
			let currentLocationSort = 'compliance_desc';

            // Variable to store the original expiration date when renewing
            let originalRenewalExpirationDate = null;

            const PREDEFINED_LOCATIONS = [
                { id: 'paranaque', name: 'Paranaque' },
                { id: 'laguna', name: 'Laguna' },
                { id: 'dumaguete', name: 'Dumaguete' },
                { id: 'bgc', name: 'BGC' },
            ];

            const documentNameOptions = {
                "City Mayor's Office": ["Mayor's / Business Permit", "Other"],
                "City Engineer's Office": ["Mechanical Permit", "Eletrical Permit", "Plumbing Permit", "Electronics Permit", "Building Permit", "Occupancy Permit", "City Engineer's Inspection Certificate", "Other"],
                "City Health Office": ["Sanitary Permit", "Other"],
                "Barangay Office": ["Barangay Clearance", "Environmental Clearance", "Other"],
                "Bureau of Fire & Protection (BFP)": ["Fire Drill Certificate 1", "Fire Drill Certificate 2", "BFP Site Inspection Report", "Fire Safety Maintenance Report", "Fuel Tank Clearance", "Fire Safety Inspection Certificate (FSIC)", "Other"],
                "Department of Environment & Natural Resources (DENR)": ["Certificate of Non-Coverage (CNC)", "HazWaste ID (HWID)", "Pollution Control Officer Certificate", "Permit to Operate (Generator Sets)", "Water Discharge Permit", "Self Monitoring Report Q1", "Self Monitoring Report Q2", "Self Monitoring Report Q3", "Self Monitoring Report Q4", "Other"],
                "Philippine Economic Zone Authority (PEZA)": ["Certificate of Registration", "Occupancy Permit", "Certificate of Annual Inspection", "Permit to Operate (Electrical Equipment)", "Permit to Operate (Mechanical Equipment)", "Permit to Operate (Electronics Equipment)", "Other"],
                "BFP Central Liaison Unit (BFP-CLU)": ["Other"],
                "Department of Labor & Employment (DOLE)": ["Work Environment Measurement Report (WEM)", "NCII Electrical Installation", "NCII DOMRAC", "Permit to Operate (Electrical Equipment)", "Permit to Operate (Mechanical Equipment)", "Other"],
                "Department of Energy (DOE)": ["Energy Audit", "Annual Energy Efficiency & Conservation Report (AEECR)", "Annual Energy Utilization Report (AEUR)", "Other"],
                "International Organization for Standardization (ISO)": ["ISO 14001:2015 Environmental Management System", "Other"],
                "Laguna Lake Development Agency (LLDA)": ["Certificate of Interconnection", "Water Discharge Permit", "Other"],
                "Other": ["Other"] // Added for the new functionality
            };

            const masterDocumentList = [...new Set(Object.values(documentNameOptions).flat())].filter(name => name !== 'Other');
            const locationRequirements = {
                paranaque: masterDocumentList,
                laguna: masterDocumentList,
                dumaguete: masterDocumentList,
                bgc: masterDocumentList
            };


            const entityNameOptions = {
                "paranaque": ["SPi Tech", "PSIDC", "SPiT Foundation", "AOPH", "Concessionaire", "Water Vendor", "Other"],
                "laguna": ["SPi Tech > C3-6 Bldg.", "SPi Tech > C3-7 Bldg.", "Concessionaire", "Water Vendor", "Other"],
                "dumaguete": ["SPi Tech", "Concessionaire", "Water Vendor", "Other"],
                "bgc": ["SPi Tech", "Other"]
            };
            
            // --- DOM Elements ---
            const globalNotificationDiv = document.getElementById('globalNotification');
            const notificationMessageSpan = document.getElementById('notificationMessage');
            const locationSelect = document.getElementById('location-select');
            const addDocumentBtn = document.getElementById('addDocumentBtn');
            const renewDocumentBtn = document.getElementById('renewDocumentBtn');
            const filterInputs = document.querySelectorAll('input[name="documentFilter"]');
            const filterAgencyNameInput = document.getElementById('filter-agency-name');
            const filterDocumentNameInput = document.getElementById('filter-document-name');
            const notificationsList = document.getElementById('notificationsList');
            const documentsTable = document.getElementById('documentsTable');
            const documentsTableBody = document.getElementById('documentsTableBody');
            const documentsTableFoot = document.getElementById('documentsTableFoot');
            const archivedTableFoot = document.getElementById('archivedTableFoot');
            const documentModal = document.getElementById('documentModal');
            const modalTitle = document.getElementById('modal-title');
            const documentForm = document.getElementById('documentForm');
            const saveDocumentBtn = document.getElementById('saveDocumentBtn');
            const cancelDocumentBtn = document.getElementById('cancelDocumentBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const currentAttachmentP = document.getElementById('current-attachment');
            const renewModal = document.getElementById('renewModal');
            const closeRenewModalBtn = document.getElementById('closeRenewModalBtn');
            const renewDocSelect = document.getElementById('renew-doc-select');
            const renewLocationInfo = document.getElementById('renew-location-info');
            const renewConfirmBtn = document.getElementById('renew-confirm');
            const renewCancelBtn = document.getElementById('renew-cancel');
            const themeSwitcher = document.getElementById('theme-switcher');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const toggleArchivedTableBtn = document.getElementById('toggleArchivedTableBtn');
            const archivedTableContainer = document.getElementById('archivedTableContainer');
            const filterArchivedAgencyInput = document.getElementById('filter-archived-agency');
            const filterArchivedDocumentInput = document.getElementById('filter-archived-document');
            const formAgencyNameSelect = document.getElementById('form-agency-name');
            const formAgencyNameOtherInput = document.getElementById('form-agency-name-other');
            const formDocumentNameSelect = document.getElementById('form-document-name');
            const formDocumentNameOtherInput = document = document.getElementById('form-document-name-other');
            const formEntityNameSelect = document.getElementById('form-entity-name');
            const formEntityNameOtherInput = document.getElementById('form-entity-name-other');
            const formLocationSelect = document.getElementById('form-location');
            const manageDocumentsSection = document.getElementById('manage-documents-section');
			const locationSortingControls = document.getElementById('location-sorting-controls');
			const generateReportBtn = document.getElementById('generateReportBtn');
            const generateFullReportBtn = document.getElementById('generateFullReportBtn');
			const statusLogModal = document.getElementById('statusLogModal');
            const closeStatusLogModalBtn = document.getElementById('closeStatusLogModalBtn');
            const statusLogTitle = document.getElementById('statusLogTitle');
            const commentHistoryList = document.getElementById('commentHistoryList');
            const newCommentForm = document.getElementById('newCommentForm');
            const newCommentText = document.getElementById('newCommentText');
            const newCommentor = document.getElementById('newCommentor');
            
            const formErrorElements = {
                'agency-name': document.getElementById('agency-name-error'),
                'document-name': document.getElementById('document-name-error'),
                'document-number': document.getElementById('document-number-error'),
                'issuance-date': document.getElementById('issuance-date-error'),
                'expiration-date': document.getElementById('expiration-date-error'),
                'date-order': document.getElementById('date-order-error'),
                'location': document.getElementById('location-error'),
                'entity-name': document.getElementById('entity-name-error'),
                'renewal-date': document.getElementById('renewal-date-error') // Added for renewal validation
            };

            const archivedDocumentsTable = document.getElementById('archivedDocumentsTable');
            const archivedDocumentsTableBody = document.getElementById('archivedDocumentsTableBody');
            const filterArchivedLocationSelect = document.getElementById('filter-archived-location'); // New filter
            const filterArchivedYearSelect = document.getElementById('filter-archived-year'); // New filter
			const notificationActionModal = document.getElementById('notificationActionModal');
            const closeNotificationActionModalBtn = document.getElementById('closeNotificationActionModalBtn');
            const notificationActionTitle = document.getElementById('notificationActionTitle');
            const notificationActionContent = document.getElementById('notificationActionContent');
            const actionViewStatusBtn = document.getElementById('actionViewStatusBtn');
            const actionRenewBtn = document.getElementById('actionRenewBtn');

            // Add Modal controls for one-time issuance
            const addExpInput = document.getElementById('form-expiration-date');
            const addOneTimeCheckbox = document.getElementById('oneTimeIssuanceCheckbox');

            // About / Version Info Panel elements
            const aboutPanelHeader = document.getElementById('aboutPanelHeader');
            const aboutPanelContent = document.getElementById('aboutPanelContent');
            const toggleAboutPanelBtn = document.getElementById('toggleAboutPanelBtn');

            // Preview Modal Elements
            const previewModal = document.getElementById('previewModal');
            const closePreviewModalBtn = document.getElementById('closePreviewModalBtn');
            const previewModalTitle = document.getElementById('preview-modal-title');
            const previewContent = document.getElementById('previewContent');
            const downloadPreviewBtn = document.getElementById('downloadPreviewBtn');
            const zoomInBtn = document.getElementById('zoomInBtn');
            const zoomOutBtn = document.getElementById('zoomOutBtn');
            let currentPreviewScale = 1; // For image zoom

            // Compliance Details Modal Elements
            const complianceDetailsModal = document.getElementById('complianceDetailsModal');
            const closeComplianceModalBtn = document.getElementById('closeComplianceModalBtn');
            const complianceModalTitle = document.getElementById('compliance-modal-title');
            const compliantDocsList = document.getElementById('compliant-docs-list');
            const lackingDocsList = document.getElementById('lacking-docs-list');
            const expiredDocsList = document.getElementById('expired-docs-list');
            const expiringDocsList = document.getElementById('expiring-docs-list');


            // --- Helper Functions ---
            
            function formatDate(dateInput) {
                if (!dateInput) return 'N/A';
                const date = new Date(dateInput);
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                return new Date(date.getTime() + userTimezoneOffset).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
            }

            function generateUUID() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            function displayGlobalMessage(message, type = 'error') {
                notificationMessageSpan.textContent = message;
                globalNotificationDiv.className = 'error-display active';
                if (type === 'success') {
                    globalNotificationDiv.style.backgroundColor = 'var(--color-success-bg)';
                    globalNotificationDiv.style.borderColor = 'var(--color-success)';
                    notificationMessageSpan.style.color = 'var(--color-success)';
                } else {
                    globalNotificationDiv.style.backgroundColor = 'var(--color-danger-bg)';
                    globalNotificationDiv.style.borderColor = 'var(--color-danger)';
                    notificationMessageSpan.style.color = 'var(--color-danger)';
                }
                setTimeout(() => globalNotificationDiv.classList.remove('active'), 4000);
            }

            function saveDataToLocalStorage(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) {
                    console.error("Error saving to localStorage:", e);
                    displayGlobalMessage("Failed to save data. Storage might be full.");
                }
            }

            function loadDataFromLocalStorage(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : [];
                } catch (e) {
                    console.error("Error loading from localStorage:", e);
                    return [];
                }
            }
            
            const createTableCell = (content, className = '') => {
                const cell = document.createElement('td');
                if (typeof content === 'string') {
                    cell.textContent = content;
                } else {
                    cell.appendChild(content);
                }
                if(className) cell.className = className;
                return cell;
            };
            
            const filterDocuments = (docs, agencyName, docName, locationId, year) => {
                const agencyFilter = agencyName ? agencyName.toLowerCase().trim() : '';
                const docNameFilter = docName ? docName.toLowerCase().trim() : '';
                const locationFilter = locationId ? locationId : '';
                const yearFilter = year ? parseInt(year) : null;

                return docs.filter(doc => 
                    (agencyFilter ? doc.agencyName.toLowerCase().includes(agencyFilter) : true) &&
                    (docNameFilter ? doc.documentName.toLowerCase().includes(docNameFilter) : true) &&
                    (locationFilter ? doc.locationId === locationFilter : true) &&
                    (yearFilter ? new Date(doc.archivedAt || doc.issuanceDate).getFullYear() === yearFilter : true) // Use archivedAt for archived docs, or issuanceDate as fallback
                );
            };

            function getNotificationStatus(doc) {
                if (doc.oneTimeIssuance) {
                    return { status: 'N/A (One-Time)', type: 'success' };
                }

                const today = new Date();
                today.setHours(0,0,0,0);
                const expDate = new Date(doc.expirationDate);
                const userTimezoneOffset = expDate.getTimezoneOffset() * 60000;
                const localExpDate = new Date(expDate.getTime() + userTimezoneOffset);
                localExpDate.setHours(0,0,0,0);
                
                const diffTime = localExpDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                if (diffDays < 0) return { status: `Expired`, type: 'danger' };
                if (diffDays <= 90) return { status: `Expires in ${diffDays}d`, type: 'warning' };
                return { status: 'Active', type: 'success' };
            }

            function getLocationNameById(locationId) {
                const location = locations.find(loc => loc.id === locationId);
                return location ? location.name : 'Unknown';
            }

            function sortDocuments(docs, key, direction) {
                return [...docs].sort((a, b) => {
                    let aVal = a[key];
                    let bVal = b[key];

                    if (key.includes('Date') || key === 'archivedAt') {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    }
                    
                    if (key === 'locationId') {
                        aVal = getLocationNameById(aVal);
                        bVal = getLocationNameById(bVal);
                    }

                    if (typeof aVal === 'string' && typeof bVal === 'string') {
                         return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    } else if (aVal < bVal) {
                        return direction === 'asc' ? -1 : 1;
                    } else if (aVal > bVal) {
                        return direction === 'asc' ? 1 : -1;
                    }
                    return 0;
                });
            }
            
            // --- UI Rendering ---

            function renderMainDocumentsTable() {
                let docsToDisplay = [...documents];
                const selectedLocation = locationSelect.value;
                if (selectedLocation) {
                    docsToDisplay = docsToDisplay.filter(doc => doc.locationId === selectedLocation);
                }
                
                const selectedFilter = document.querySelector('input[name="documentFilter"]:checked').value;
                if (selectedFilter !== 'all') {
                    docsToDisplay = docsToDisplay.filter(doc => {
                        const statusType = getNotificationStatus(doc).type;
                        if (selectedFilter === 'non-expiring') return statusType === 'success';
                        if (selectedFilter === 'expiring') return statusType === 'warning' || statusType === 'danger';
                        return true;
                    });
                }
                
                docsToDisplay = filterDocuments(docsToDisplay, filterAgencyNameInput.value, filterDocumentNameInput.value);
                
                if (currentMainSortKey) {
                    docsToDisplay = sortDocuments(docsToDisplay, currentMainSortKey, currentMainSortDirection);
                }

                documentsTable.querySelectorAll('.sort-header').forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc');
                    if (header.dataset.sortKey === currentMainSortKey) {
                        header.classList.add(`sort-${currentMainSortDirection}`);
                    }
                });
                
                documentsTableBody.innerHTML = '';
                documentsTableFoot.classList.toggle('hidden', docsToDisplay.length > 0);

                docsToDisplay.forEach(doc => {
                    const row = documentsTableBody.insertRow();
                    row.dataset.docId = doc.id;
                    const status = getNotificationStatus(doc);

                    if (status.type === 'danger') row.classList.add('row-expired');
                    else if (status.type === 'warning') row.classList.add('row-expiring');
                    
                    const statusSpan = document.createElement('span');
                    statusSpan.className = `status-span ${status.type}`;
                    statusSpan.textContent = status.status;
                    
                    // Create the Agency cell with conditional button
                    const agencyCell = createTableCell(doc.agencyName);
                    if (status.type === 'warning' || status.type === 'danger') {
                        agencyCell.classList.add('agency-cell-flex');
                        const renewalButtonHTML = `<button class="renewal-status-button" data-doc-id="${doc.id}">Renewal Status</button>`;
                        agencyCell.innerHTML = `<span>${doc.agencyName}</span>${renewalButtonHTML}`;
                    }
                    
                    const actionsCell = document.createElement('div');
                    actionsCell.className = 'actions-cell';
                    if (doc.attachmentData) {
                        actionsCell.innerHTML += `<span class="attachment-indicator" data-id="${doc.id}" title="Preview: ${doc.attachmentName}">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.122 2.122l7.81-7.81"></path></svg>
                        </span>`;
                    } else {
                        actionsCell.innerHTML += `<span class="attachment-indicator" title="No Attachment">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1.2rem; height:1.2rem; opacity: 0.5;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739L16.29 14.825a.75.75 0 00-1.06 0L13.14 17.51a.75.75 0 000 1.06l2.086 2.086a4.5 4.5 0 006.364-6.364l-1.094-1.094zM12.739 18.375L14.825 16.29a.75.75 0 000-1.06L17.51 13.14a.75.75 0 001.06 0l2.086 2.086a4.5 4.5 0 000-6.364L12.739 5.625M.525 5.625L5.625 10.739M10.739 5.625L5.625 10.739M5.625 10.739V5.625" />
                            </svg>
                        </span>`;
                    }

                    const isDisabled = status.type === 'danger' || status.type === 'warning';
                    const disabledAttribute = isDisabled ? 'disabled' : '';
                    
                    let editTooltipText = `Edit Document`;
                    let deleteTooltipText = `Delete Document`;

                    if (isDisabled) {
                        editTooltipText = 'Disabled: Document is expiring/expired';
                        deleteTooltipText = 'Disabled: Document is expiring/expired';
                    }

                    actionsCell.innerHTML += `
                        <button data-id="${doc.id}" class="action-button edit-button-icon" title="${editTooltipText}" ${disabledAttribute}>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                        </button>
                        <button data-id="${doc.id}" class="action-button delete-button-icon" title="${deleteTooltipText}" ${disabledAttribute}>
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1rem; height:1rem;">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M6 7h12M9 7V5a1 1 0 011-1h4a1 1 0 011 1v2m-7 0h8m-9 4v6m4-6v6m4-6v6M4 7h16l-1 12a2 2 0 01-2 2H7a2 2 0 01-2-2L4 7z"/>
                           </svg>
                        </button>`;
                    
                    row.appendChild(agencyCell);
                    row.appendChild(createTableCell(doc.documentName));
                    row.appendChild(createTableCell(doc.documentNumber));
                    row.appendChild(createTableCell(formatDate(doc.issuanceDate)));
                    row.appendChild(createTableCell(doc.oneTimeIssuance ? 'N/A (One-Time)' : formatDate(doc.expirationDate)));
                    row.appendChild(createTableCell(getLocationNameById(doc.locationId)));
                    row.appendChild(createTableCell(doc.entityName || 'N/A'));
                    row.appendChild(createTableCell(statusSpan));
                    row.appendChild(createTableCell(actionsCell));
                });
            }

            function renderArchivedDocumentsTable() {
                const agencyFilter = filterArchivedAgencyInput.value;
                const docNameFilter = filterArchivedDocumentInput.value;
                const locationFilter = filterArchivedLocationSelect.value;
                const yearFilter = filterArchivedYearSelect.value;

                let filteredArchived = filterDocuments(archivedDocuments, agencyFilter, docNameFilter, locationFilter, yearFilter);
                
                if (currentArchivedSortKey) {
                    filteredArchived = sortDocuments(filteredArchived, currentArchivedSortKey, currentArchivedSortDirection);
                }
                
                archivedTableFoot.classList.toggle('hidden', filteredArchived.length > 0);
                archivedDocumentsTableBody.innerHTML = '';
                
                archivedDocumentsTable.querySelectorAll('.sort-header').forEach(header => {
                    header.classList.remove('sort-asc', 'sort-desc');
                    if (header.dataset.sortKey === currentArchivedSortKey) {
                        header.classList.add(`sort-${currentArchivedSortDirection}`);
                    }
                });

                filteredArchived.forEach(doc => {
                    const row = archivedDocumentsTableBody.insertRow();
                    
                    const agencyCell = createTableCell(doc.agencyName);
                    if (doc.comments && doc.comments.length > 0) {
                        agencyCell.classList.add('agency-cell-flex');
                        const logButtonHTML = `<button class="renewal-status-button view-log-btn" data-doc-id="${doc.id}">View Log</button>`;
                        agencyCell.innerHTML = `<span>${doc.agencyName}</span>${logButtonHTML}`;
                    }
                    
                    const actionsCell = document.createElement('div');
                    actionsCell.className = 'actions-cell';
                    if (doc.attachmentData) {
                        actionsCell.innerHTML += `<span class="attachment-indicator" data-id="${doc.id}" title="Preview: ${doc.attachmentName}">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m18.375 12.739-7.693 7.693a4.5 4.5 0 0 1-6.364-6.364l10.94-10.94A3 3 0 1 1 19.5 7.372L8.552 18.32m.009-.01-.01.01m5.699-9.941-7.81 7.81a1.5 1.5 0 0 0 2.122 2.122l7.81-7.81"></path></svg>
                        </span>`;
                    } else {
                        actionsCell.innerHTML += `<span class="attachment-indicator" title="No Attachment">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1.2rem; height:1.2rem; opacity: 0.5;">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739L16.29 14.825a.75.75 0 00-1.06 0L13.14 17.51a.75.75 0 000 1.06l2.086 2.086a4.5 4.5 0 006.364-6.364l-1.094-1.094zM12.739 18.375L14.825 16.29a.75.75 0 000-1.06L17.51 13.14a.75.75 0 001.06 0l2.086 2.086a4.5 4.5 0 000-6.364L12.739 5.625M.525 5.625L5.625 10.739M10.739 5.625L5.625 10.739M5.625 10.739V5.625" />
                            </svg>
                        </span>`;
                    }

                    row.appendChild(agencyCell);
                    row.appendChild(createTableCell(doc.documentName));
                    row.appendChild(createTableCell(doc.documentNumber));
                    row.appendChild(createTableCell(formatDate(doc.issuanceDate)));
                    row.appendChild(createTableCell(doc.oneTimeIssuance ? 'N/A (One-Time)' : formatDate(doc.expirationDate)));
                    row.appendChild(createTableCell(getLocationNameById(doc.locationId)));
                    row.appendChild(createTableCell(doc.entityName || 'N/A'));
                    row.appendChild(createTableCell(formatDate(doc.archivedAt)));
                    row.appendChild(createTableCell(actionsCell));
                });
            }

                function renderNotifications() {
                notificationsList.innerHTML = '';
                const expiringDocs = documents
                    .map(doc => ({...doc, status: getNotificationStatus(doc)}))
                    .filter(doc => doc.status.type === 'warning' || doc.status.type === 'danger') 
                    .sort((a, b) => new Date(a.expirationDate) - new Date(b.expirationDate));

                if (expiringDocs.length === 0) {
                    notificationsList.innerHTML = '<li>All documents are up-to-date.</li>';
                    return;
                }
                
                expiringDocs.forEach(doc => {
                    const li = document.createElement('li');
                    li.classList.add('clickable');
                    li.dataset.docId = doc.id;
                    const className = doc.status.type === 'danger' ? 'text-red-700' : 'text-custom-green-teal';
                    li.innerHTML = `<span class="${className}"><strong>${doc.documentName}</strong> (${getLocationNameById(doc.locationId)}) ${doc.status.type === 'danger' ? 'has expired' : 'is expiring soon'}.</span>`;
                    notificationsList.appendChild(li);
                });
            }

            function updateComplianceDashboard() {
                complianceDataCache = {}; 
                let overallTotalRequired = 0;
                let overallTotalCompliant = 0;

                locations.forEach(loc => {
                    const requiredDocNames = new Set(locationRequirements[loc.id] || []);
                    const docsForLocation = documents.filter(doc => doc.locationId === loc.id);
                    const presentDocNames = new Set(docsForLocation.map(d => d.documentName));

                    const compliantDocs = [];
                    const expiringDocs = [];
                    const expiredDocs = [];

                    docsForLocation.forEach(doc => {
                        const status = getNotificationStatus(doc);
                        if (status.type === 'success') compliantDocs.push(doc);
                        else if (status.type === 'warning') expiringDocs.push(doc);
                        else if (status.type === 'danger') expiredDocs.push(doc);
                    });
                    
                    const lackingDocs = [...requiredDocNames].filter(reqName => !presentDocNames.has(reqName));

                    const totalRequired = requiredDocNames.size;
                    const totalCompliant = compliantDocs.length;
                    
                    overallTotalRequired += totalRequired;
                    overallTotalCompliant += totalCompliant;

                    const percent = totalRequired > 0 ? Math.round((totalCompliant / totalRequired) * 100) : 0;

                    complianceDataCache[loc.id] = { 
                        compliantDocs, 
                        lackingDocs, 
                        expiredDocs, 
                        expiringDocs, 
                        percent, 
                        name: loc.name
                    };
                });

                const overallPercent = overallTotalRequired > 0 ? Math.round((overallTotalCompliant / overallTotalRequired) * 100) : 0;
                const donutChart = document.getElementById('overall-donut-chart');
                
                // Update Donut Chart
                document.getElementById('donut-chart-percent').textContent = `${overallPercent}%`;
                document.getElementById('donut-chart-ratio').textContent = `${overallTotalCompliant} / ${overallTotalRequired} docs`;
                
                let donutColor = 'var(--color-success)';
                if (overallPercent < 50) {
                    donutColor = 'var(--color-danger)';
                } else if (overallPercent <= 75) {
                    donutColor = 'var(--color-warning)';
                }
                donutChart.style.background = `conic-gradient(${donutColor} ${overallPercent * 3.6}deg, var(--color-border) 0deg)`;

                renderLocationProgressBars();
            }
			
			function renderLocationProgressBars() {
                const locationContainer = document.querySelector('.location-progress-bars');
                locationContainer.innerHTML = ''; 

                let sortedLocations = Object.values(complianceDataCache);

                switch (currentLocationSort) {
                    case 'compliance_asc':
                        sortedLocations.sort((a, b) => a.percent - b.percent);
                        break;
                    case 'compliance_desc':
                        sortedLocations.sort((a, b) => b.percent - a.percent);
                        break;
                    case 'name_asc':
                        sortedLocations.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                }

                sortedLocations.forEach(data => {
                    const locId = locations.find(l => l.name === data.name).id;
                    const percent = data.percent;
                    const totalCompliant = data.compliantDocs.length;
                    const totalRequired = data.lackingDocs.length + data.compliantDocs.length + data.expiredDocs.length + data.expiringDocs.length;
                    
                    let statusClass = 'status-high';
                    if (percent < 50) {
                        statusClass = 'status-low';
                    } else if (percent <= 75) {
                        statusClass = 'status-medium';
                    }
                    
                    // Create the tooltip string
                    const tooltip = `Compliant: ${data.compliantDocs.length}\nLacking: ${data.lackingDocs.length}\nExpired: ${data.expiredDocs.length}\nExpiring Soon: ${data.expiringDocs.length}`;
                    
                    // Add the title attribute to the main div
                    const barHTML = `
                        <div class="location-progress-bar" data-location-id="${locId}" title="${tooltip}">
                            <div class="progress-bar-label">
                                <span>${data.name}</span>
                                <span>${totalCompliant} / ${totalRequired} docs</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-bar-inner ${statusClass}" style="width: ${percent}%;"></div>
                                <span class="progress-bar-text">${percent}%</span>
                            </div>
                        </div>
                    `;
                    locationContainer.innerHTML += barHTML;
                });
            }

            function openComplianceDetailsModal(locationId) {
                const data = complianceDataCache[locationId];
                if (!data) return;

                const locationName = getLocationNameById(locationId);
                complianceModalTitle.textContent = `Compliance Details: ${locationName}`;

                compliantDocsList.innerHTML = data.compliantDocs.length > 0 
                    ? data.compliantDocs.map(d => `<li data-doc-id="${d.id}" data-doc-type="compliant">${d.documentName}</li>`).join('') 
                    : '<li>None</li>';

                lackingDocsList.innerHTML = data.lackingDocs.length > 0 
                    ? data.lackingDocs.map(name => `<li data-doc-name="${name}" data-location-id="${locationId}" data-doc-type="lacking">${name}</li>`).join('') 
                    : '<li>None</li>';

                expiredDocsList.innerHTML = data.expiredDocs.length > 0 
                    ? data.expiredDocs.map(d => `<li data-doc-id="${d.id}" data-doc-type="expired">${d.documentName} <span style="font-size:0.8em; color: var(--color-danger);"> (Expired: ${formatDate(d.expirationDate)})</span></li>`).join('')
                    : '<li>None</li>';

                expiringDocsList.innerHTML = data.expiringDocs.length > 0 
                    ? data.expiringDocs.map(d => `<li data-doc-id="${d.id}" data-doc-type="expiring">${d.documentName} <span style="font-size:0.8em; color: var(--color-warning);">(Expires: ${formatDate(d.expirationDate)})</span></li>`).join('')
                    : '<li>None</li>';

                complianceDetailsModal.classList.add('active');
            }

            function closeComplianceDetailsModal() {
                complianceDetailsModal.classList.remove('active');
            }
			
			function openStatusLogModal(doc, isReadOnly = false) {
                statusLogTitle.innerHTML = `Renewal Status Log<br><small style="font-weight: normal; font-size: 0.9rem; color: var(--color-text-secondary);">${doc.documentName} at ${getLocationNameById(doc.locationId)}</small>`;
                newCommentForm.dataset.docId = doc.id;
                commentHistoryList.innerHTML = ''; // Clear previous
                
                // Hide or show the form based on read-only status
                newCommentForm.style.display = isReadOnly ? 'none' : 'block';

                if (doc.comments && doc.comments.length > 0) {
                    const sortedComments = [...doc.comments].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    sortedComments.forEach(comment => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="comment-meta">
                                <span>${new Date(comment.timestamp).toLocaleString()}</span> - <strong>${comment.commentor}</strong>
                            </div>
                            <p class="comment-text">${comment.text}</p>
                        `;
                        commentHistoryList.appendChild(li);
                    });
                } else {
                    commentHistoryList.innerHTML = '<li>No log entries yet.</li>';
                }
                
                statusLogModal.classList.add('active');
                if (!isReadOnly) {
                    newCommentText.focus();
                }
            }

            function closeStatusLogModal() {
                statusLogModal.classList.remove('active', 'modal-on-top'); // <-- MODIFIED LINE
                newCommentForm.reset();
                delete newCommentForm.dataset.docId;
            }
			
			function openNotificationActionModal(doc) {
                notificationActionTitle.textContent = 'Action For:';
                notificationActionContent.innerHTML = `<strong>${doc.documentName}</strong><br><small>(${getLocationNameById(doc.locationId)})</small>`;
                actionViewStatusBtn.dataset.docId = doc.id;
                actionRenewBtn.dataset.docId = doc.id;
                notificationActionModal.classList.add('active');
            }

            function closeNotificationActionModal() {
                notificationActionModal.classList.remove('active');
            }
			
			function generateComplianceReport(locationIds) {
                const reportWindow = window.open('', '_blank');
                let reportHtml = `
                    <html>
                    <head>
                        <title>Compliance Status Report</title>
                        <style>
                            @page { size: A4; margin: 2cm; }
                            body { font-family: 'Inter', sans-serif; font-size: 10pt; }
                            .report-page { page-break-before: always; }
                            .report-page:first-child { page-break-before: avoid; }
                            h1 { font-size: 18pt; margin-bottom: 0; }
                            h2 { font-size: 14pt; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-top: 2rem; }
                            h3 { font-size: 11pt; margin-top: 1.5rem; margin-bottom: 0.5rem; }
                            ul { list-style-type: none; padding-left: 10px; }
                            li { margin-bottom: 4px; }
                            .summary-table { border-collapse: collapse; width: 50%; margin-top: 1rem; }
                            .summary-table td { border: 1px solid #ddd; padding: 6px; }
                            .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 2px solid #333; padding-bottom: 10px; }
                            .header-text p { margin: 0; }
                            .logo { font-size: 16pt; font-weight: 700; color: #FF8C00; }
                        </style>
                    </head>
                    <body>`;

                locationIds.forEach(locId => {
                    const data = complianceDataCache[locId];
                    if (!data) return;

                    const locationName = getLocationNameById(locId);
                    const totalRequired = data.lackingDocs.length + data.compliantDocs.length + data.expiredDocs.length + data.expiringDocs.length;

                    reportHtml += `
                        <div class="report-page">
                            <div class="header">
                                <div class="header-text">
                                    <h1>Compliance Status Report</h1>
                                    <p>Generated on: ${new Date().toLocaleString()}</p>
                                </div>
                                <div class="logo">FMG</div>
                            </div>
                            <h2>Location: ${locationName}</h2>
                            <table class="summary-table">
                                <tr><td>Overall Compliance</td><td><strong>${data.percent}%</strong></td></tr>
                                <tr><td>Compliant Documents</td><td>${data.compliantDocs.length} of ${totalRequired}</td></tr>
                                <tr><td>Non-Compliant Documents</td><td>${data.lackingDocs.length + data.expiredDocs.length + data.expiringDocs.length}</td></tr>
                            </table>

                            <h3>Compliant Documents (${data.compliantDocs.length})</h3>
                            <ul>${data.compliantDocs.length > 0 ? data.compliantDocs.map(d => `<li>${d.documentName}</li>`).join('') : '<li>None</li>'}</ul>
                            
                            <h3>Non-Compliant Documents</h3>
                            <h4>Lacking (${data.lackingDocs.length})</h4>
                            <ul>${data.lackingDocs.length > 0 ? data.lackingDocs.map(name => `<li>${name}</li>`).join('') : '<li>None</li>'}</ul>
                            
                            <h4>Expired (${data.expiredDocs.length})</h4>
                            <ul>${data.expiredDocs.length > 0 ? data.expiredDocs.map(d => `<li>${d.documentName} (Expired: ${formatDate(d.expirationDate)})</li>`).join('') : '<li>None</li>'}</ul>

                            <h4>Expiring Soon (${data.expiringDocs.length})</h4>
                            <ul>${data.expiringDocs.length > 0 ? data.expiringDocs.map(d => `<li>${d.documentName} (Expires: ${formatDate(d.expirationDate)})</li>`).join('') : '<li>None</li>'}</ul>
                        </div>
                    `;
                });

                reportHtml += `</body></html>`;
                reportWindow.document.write(reportHtml);
                reportWindow.document.close();
                reportWindow.print();
            }


            function updateUI() {
                renderLocations();
                populateArchivedFilters(); 
                updateComplianceDashboard();
                renderMainDocumentsTable();
                renderArchivedDocumentsTable();
                renderNotifications();
            }

            function renderLocations() {
                const selectedVal = locationSelect.value;
                locationSelect.innerHTML = '<option value="">All Locations</option>';
                formLocationSelect.innerHTML = '<option value="">Select a location</option>';
                filterArchivedLocationSelect.innerHTML = '<option value="">All Locations</option>';

                locations.forEach(loc => {
                    const option = new Option(loc.name, loc.id);
                    locationSelect.add(option.cloneNode(true));
                    formLocationSelect.add(option.cloneNode(true));
                    filterArchivedLocationSelect.add(option);
                });
                locationSelect.value = selectedVal;
            }

            function populateArchivedFilters() {
                const years = new Set();
                archivedDocuments.forEach(doc => {
                    if (doc.archivedAt) {
                        years.add(new Date(doc.archivedAt).getFullYear());
                    }
                });
                const sortedYears = Array.from(years).sort((a, b) => b - a);

                filterArchivedYearSelect.innerHTML = '<option value="">All Years</option>';
                sortedYears.forEach(year => {
                    filterArchivedYearSelect.add(new Option(year, year));
                });
            }

            function updateDocumentNameOptions(agency, selectedDocName = null) {
                formDocumentNameSelect.innerHTML = '<option value="">Select a Document Name</option>';
                const options = (agency === "Other") ? ["Other"] : (documentNameOptions[agency] || []);
                
                options.forEach(opt => {
                    formDocumentNameSelect.add(new Option(opt, opt));
                });

                if (selectedDocName) {
                    const isPredefined = options.includes(selectedDocName);
                    if (isPredefined) {
                        formDocumentNameSelect.value = selectedDocName;
                    } else if (options.length > 0) {
                        formDocumentNameSelect.value = 'Other';
                        formDocumentNameOtherInput.value = selectedDocName;
                        formDocumentNameOtherInput.classList.remove('hidden');
                    }
                }
            }
            
            function updateEntityNameOptions(locationId, selectedEntityName = null) {
                formEntityNameSelect.innerHTML = '<option value="">Select an Entity</option>';
                const options = entityNameOptions[locationId] || [];
                options.forEach(opt => {
                    formEntityNameSelect.add(new Option(opt, opt));
                });

                if (selectedEntityName) {
                    const isPredefined = options.includes(selectedEntityName);
                    if (isPredefined) {
                        formEntityNameSelect.value = selectedEntityName;
                    } else if (options.length > 0) {
                        formEntityNameSelect.value = 'Other';
                        formEntityNameOtherInput.value = selectedEntityName;
                        formEntityNameOtherInput.classList.remove('hidden');
                    }
                }
            }

            function openDocumentModal(docToEdit = null, isRenewal = false, prefillData = null) {
                documentForm.reset();
                Object.values(formErrorElements).forEach(el => el.classList.add('hidden'));
                formAgencyNameOtherInput.classList.add('hidden');
                formDocumentNameOtherInput.classList.add('hidden');
                formEntityNameOtherInput.classList.add('hidden');
                
                const submitButton = documentForm.querySelector('button[type="submit"]');
                originalRenewalExpirationDate = null;

                if (prefillData) {
                    modalTitle.textContent = 'Add New Document';
                    submitButton.textContent = 'Add Document';
                    submitButton.id = 'saveDocumentBtn';
                    
                    formLocationSelect.value = prefillData.locationId;
                    formAgencyNameSelect.value = prefillData.agencyName;
                    updateDocumentNameOptions(prefillData.agencyName, prefillData.documentName);
                    updateEntityNameOptions(prefillData.locationId);
                    
                } else if (docToEdit) {
                    modalTitle.textContent = isRenewal ? 'Renew Document' : 'Edit Document';
                    submitButton.textContent = isRenewal ? 'Renew Document' : 'Save Changes';
                    submitButton.id = isRenewal ? 'renew-confirm-form' : 'saveDocumentBtn';

                    document.getElementById('form-document-id').value = isRenewal ? '' : docToEdit.id;
                    
                    const isPredefinedAgency = Array.from(formAgencyNameSelect.options).some(opt => opt.value === docToEdit.agencyName);
                    if (isPredefinedAgency) {
                        formAgencyNameSelect.value = docToEdit.agencyName;
                    } else {
                        formAgencyNameSelect.value = 'Other';
                        formAgencyNameOtherInput.value = docToEdit.agencyName;
                        formAgencyNameOtherInput.classList.remove('hidden');
                    }

                    updateDocumentNameOptions(formAgencyNameSelect.value, docToEdit.documentName);
                    
                    formLocationSelect.value = docToEdit.locationId;
                    updateEntityNameOptions(docToEdit.locationId, docToEdit.entityName);

                    document.getElementById('form-document-number').value = docToEdit.documentNumber;
                    document.getElementById('form-issuance-date').value = docToEdit.issuanceDate;
                    
                    if (addOneTimeCheckbox) {
                        addOneTimeCheckbox.checked = !!docToEdit.oneTimeIssuance;
                        if (addOneTimeCheckbox.checked) {
                            addExpInput.disabled = true;
                            addExpInput.removeAttribute('required');
                            addExpInput.style.backgroundColor = '#eee';
                            addExpInput.style.color = '#666';
                            addExpInput.value = '';
                        } else {
                            addExpInput.disabled = false;
                            addExpInput.setAttribute('required', 'true');
                            addExpInput.style.backgroundColor = '';
                            addExpInput.style.color = '';
                            document.getElementById('form-expiration-date').value = docToEdit.expirationDate;
                        }
                    } else {
                         document.getElementById('form-expiration-date').value = docToEdit.expirationDate;
                    }

                    if (isRenewal) {
                        originalRenewalExpirationDate = docToEdit.expirationDate;
                        document.getElementById('form-agency-name').disabled = true;
                        document.getElementById('form-agency-name-other').disabled = true;
                        document.getElementById('form-document-name').disabled = true;
                        document.getElementById('form-document-name-other').disabled = true;
                        document.getElementById('form-location').disabled = true;
                        document.getElementById('form-entity-name').disabled = true;
                        document.getElementById('form-entity-name-other').disabled = true;

                        document.getElementById('form-document-number').disabled = false;
                        document.getElementById('form-issuance-date').disabled = false;
                        document.getElementById('form-upload-document').disabled = false;
                        document.getElementById('deleteAttachmentBtn').disabled = false;
                        addOneTimeCheckbox.disabled = false;
                    } else {
                        document.getElementById('form-agency-name').disabled = false;
                        document.getElementById('form-agency-name-other').disabled = false;
                        document.getElementById('form-document-name').disabled = false;
                        document.getElementById('form-document-name-other').disabled = false;
                        document.getElementById('form-document-number').disabled = false;
                        document.getElementById('form-issuance-date').disabled = false;
                        document.getElementById('form-location').disabled = false;
                        document.getElementById('form-entity-name').disabled = false;
                        document.getElementById('form-entity-name-other').disabled = false;
                        document.getElementById('form-upload-document').disabled = false;
                        document.getElementById('deleteAttachmentBtn').disabled = false;
                        addOneTimeCheckbox.disabled = false;
                    }


                    document.getElementById('form-attachment-data').value = docToEdit.attachmentData || '';
                    document.getElementById('form-attachment-name').value = docToEdit.attachmentName || '';
                    currentAttachmentP.textContent = docToEdit.attachmentName ? `Current: ${docToEdit.attachmentName}` : 'No file attached.';
                    if(docToEdit.attachmentName){ document.getElementById('deleteAttachmentBtn').classList.remove('hidden'); } else { document.getElementById('deleteAttachmentBtn').classList.add('hidden');
                document.getElementById('form-upload-document').value = ''; }
                } else {
                    modalTitle.textContent = 'Add New Document';
                    submitButton.textContent = 'Add Document';
                    submitButton.id = 'saveDocumentBtn';
                    currentAttachmentP.textContent = 'No file attached.';
                    document.getElementById('deleteAttachmentBtn').classList.add('hidden');
                    document.getElementById('form-upload-document').value = '';
                    updateDocumentNameOptions('');
                    updateEntityNameOptions('');

                    if (addOneTimeCheckbox) {
                        addOneTimeCheckbox.checked = false;
                        addExpInput.disabled = false;
                        addExpInput.setAttribute('required', 'true');
                        addExpInput.style.backgroundColor = '';
                        addExpInput.style.color = '';
                    }

                    document.getElementById('form-agency-name').disabled = false;
                    document.getElementById('form-agency-name-other').disabled = false;
                    document.getElementById('form-document-name').disabled = false;
                    document.getElementById('form-document-name-other').disabled = false;
                    document.getElementById('form-document-number').disabled = false;
                    document.getElementById('form-issuance-date').disabled = false;
                    document.getElementById('form-location').disabled = false;
                    document.getElementById('form-entity-name').disabled = false;
                    document.getElementById('form-entity-name-other').disabled = false;
                    document.getElementById('form-upload-document').disabled = false;
                    document.getElementById('deleteAttachmentBtn').disabled = false;
                    addOneTimeCheckbox.disabled = false;
                }

                documentModal.classList.add('active');
                document.getElementById('form-agency-name').focus();
            }

            function closeDocumentModal() {
                documentModal.classList.remove('active', 'modal-on-top'); // <-- MODIFIED LINE
                sessionStorage.removeItem('renewingDocId');
                originalRenewalExpirationDate = null;
            }
            
            function openRenewModal() {
                const docsForRenewal = documents.filter(doc => {
                    const status = getNotificationStatus(doc);
                    return status.type === 'warning' || status.type === 'danger';
                });

                renewDocSelect.innerHTML = '<option value="">--Please choose an option--</option>';
                if (docsForRenewal.length === 0) {
                     renewDocSelect.innerHTML = '<option value="" disabled>No documents to renew</option>';
                } else {
                    docsForRenewal.forEach(doc => {
                        renewDocSelect.add(new Option(`${doc.documentName} (${doc.agencyName})`, doc.id));
                    });
                }
                renewConfirmBtn.disabled = true;
                renewModal.classList.add('active');
            }
            
            function closeRenewModal() {
                renewModal.classList.remove('active');
            }

            function validateForm() {
                let isValid = true;
                Object.values(formErrorElements).forEach(el => el.classList.add('hidden'));
                const fieldsToValidate = {
                    'document-number': 'Document Number', 'issuance-date': 'Date of Issuance',
                    'location': 'Office Location'
                };
                const _oneTimeCb = document.getElementById('oneTimeIssuanceCheckbox');
                const _skipExpiry = !!(_oneTimeCb && _oneTimeCb.checked);
                if (!_skipExpiry) {
                    fieldsToValidate['expiration-date'] = 'Date of Expiration';
                }

                if (formAgencyNameSelect.value === '') {
                    formErrorElements['agency-name'].textContent = 'Government Agency is required.';
                    formErrorElements['agency-name'].classList.remove('hidden');
                    isValid = false;
                } else if (formAgencyNameSelect.value === 'Other' && !formAgencyNameOtherInput.value.trim()) {
                    formErrorElements['agency-name'].textContent = 'Please specify the agency name.';
                    formErrorElements['agency-name'].classList.remove('hidden');
                    isValid = false;
                }

                if (formDocumentNameSelect.value === '') {
                    formErrorElements['document-name'].textContent = 'Document Name is required.';
                    formErrorElements['document-name'].classList.remove('hidden');
                    isValid = false;
                } else if (formDocumentNameSelect.value === 'Other' && !formDocumentNameOtherInput.value.trim()) {
                    formErrorElements['document-name'].textContent = 'Please specify the document name.';
                    formErrorElements['document-name'].classList.remove('hidden');
                    isValid = false;
                }

                if (formEntityNameSelect.value === '') {
                    formErrorElements['entity-name'].textContent = 'Entity Name is required.';
                    formErrorElements['entity-name'].classList.remove('hidden');
                    isValid = false;
                } else if (formEntityNameSelect.value === 'Other' && !formEntityNameOtherInput.value.trim()) {
                    formErrorElements['entity-name'].textContent = 'Please specify the entity name.';
                    formErrorElements['entity-name'].classList.remove('hidden');
                    isValid = false;
                }

                for (const id in fieldsToValidate) {
                    const input = document.getElementById(`form-${id}`);
                    if (!input.value.trim()) {
                        formErrorElements[id].textContent = `${fieldsToValidate[id]} is required.`;
                        formErrorElements[id].classList.remove('hidden');
                        isValid = false;
                    }
                }
                
                const issueDate = document.getElementById('form-issuance-date').value;
                const expiryDate = document.getElementById('form-expiration-date').value;
                if (!_skipExpiry && issueDate && expiryDate && new Date(issueDate) >= new Date(expiryDate)) {
                    formErrorElements['date-order'].textContent = 'Expiration Date must be after Issuance Date.';
                    formErrorElements['date-order'].classList.remove('hidden');
                    isValid = false;
                }

                if (originalRenewalExpirationDate && expiryDate) {
                    const newExpDate = new Date(expiryDate);
                    const oldExpDate = new Date(originalRenewalExpirationDate);
                    newExpDate.setUTCHours(0, 0, 0, 0);
                    oldExpDate.setUTCHours(0, 0, 0, 0);

                    if (newExpDate <= oldExpDate) {
                        formErrorElements['renewal-date'].textContent = 'New expiration date must be later than the current expiration date.';
                        formErrorElements['renewal-date'].classList.remove('hidden');
                        isValid = false;
                    }
                }
                return isValid;
            }
            
            function handleSaveDocument(e) {
                e.preventDefault();
                if (!validateForm()) return;
                
                const docId = document.getElementById('form-document-id').value;
                const fileInput = document.getElementById('form-upload-document');
                const file = fileInput.files[0];

                if (file && (file.size > MAX_FILE_SIZE_MB * 1024 * 1024)) {
                    displayGlobalMessage(`File is too large. Please select a file under ${MAX_FILE_SIZE_MB} MB.`, 'error');
                    fileInput.value = '';
                    return;
                }

                const isOneTimeIssuance = addOneTimeCheckbox ? addOneTimeCheckbox.checked : false;
                
                const processAndSave = (attachmentData, attachmentName) => {
                    let agencyName = formAgencyNameSelect.value;
                    if (agencyName === 'Other') agencyName = formAgencyNameOtherInput.value.trim();

                    let documentName = formDocumentNameSelect.value;
                    if (documentName === 'Other') documentName = formDocumentNameOtherInput.value.trim();

                    let entityName = formEntityNameSelect.value;
                    if (entityName === 'Other') entityName = formEntityNameOtherInput.value.trim();

                    const docData = {
                        id: docId || generateUUID(),
                        agencyName: agencyName,
                        documentName: documentName,
                        entityName: entityName,
                        documentNumber: document.getElementById('form-document-number').value.trim(),
                        issuanceDate: document.getElementById('form-issuance-date').value,
                        expirationDate: isOneTimeIssuance ? null : document.getElementById('form-expiration-date').value,
                        locationId: document.getElementById('form-location').value,
                        attachmentData: attachmentData,
                        attachmentName: attachmentName,
                        oneTimeIssuance: isOneTimeIssuance, // Store the flag
                        comments: (docId && documents.find(d => d.id === docId)?.comments) || []
                    };

                    const originalDocId = sessionStorage.getItem('renewingDocId');
                    if (originalDocId) {
                        const oldDocIndex = documents.findIndex(d => d.id === originalDocId);
                        if (oldDocIndex > -1) {
                            const [archivedDoc] = documents.splice(oldDocIndex, 1);
                            archivedDocuments.unshift({ ...archivedDoc, archivedAt: new Date().toISOString(), status: 'Archived (Renewed)' });
                            saveDataToLocalStorage(LOCAL_STORAGE_KEY_ARCHIVES, archivedDocuments);
                        }
                        sessionStorage.removeItem('renewingDocId');
                        documents.push(docData);
                    } else {
                        const existingIndex = documents.findIndex(d => d.id === docData.id);
                        if (existingIndex > -1) {
                            documents[existingIndex] = docData;
                        } else {
                            documents.push(docData);
                        }
                    }
                    
                    saveDataToLocalStorage(LOCAL_STORAGE_KEY_DOCUMENTS, documents);
                    displayGlobalMessage(docId ? 'Document updated successfully!' : 'Document added successfully!', 'success');
                    updateUI();
                    closeDocumentModal();
                };

                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => processAndSave(event.target.result, file.name);
                    reader.onerror = () => displayGlobalMessage('Error reading file.');
                    reader.readAsDataURL(file);
                } else {
                    const existingAttachmentData = document.getElementById('form-attachment-data').value;
                    const existingAttachmentName = document.getElementById('form-attachment-name').value;
                    processAndSave(existingAttachmentData, existingAttachmentName);
                }
            }

            function deleteDocument(docId) {
                const docIndex = documents.findIndex(doc => doc.id === docId);
                if (docIndex > -1) {
                    documents.splice(docIndex, 1);
                    saveDataToLocalStorage(LOCAL_STORAGE_KEY_DOCUMENTS, documents);
                    displayGlobalMessage('Document permanently deleted!', 'success');
                    updateUI();
                }
            }

            function downloadAttachment(docId) {
                const doc = documents.find(d => d.id === docId) || archivedDocuments.find(d => d.id === docId);
                if (doc && doc.attachmentData) {
                    const link = document.createElement('a');
                    link.href = doc.attachmentData;
                    link.download = doc.attachmentName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    displayGlobalMessage('Attachment not found.');
                }
            }

            function openPreviewModal(doc) {
                previewModalTitle.textContent = `Preview: ${doc.documentName} - ${doc.attachmentName}`;
                previewContent.innerHTML = '';
                currentPreviewScale = 1;

                const mimeType = doc.attachmentData.split(':')[1].split(';')[0];
                const isImage = mimeType.startsWith('image/');
                const isPdf = mimeType === 'application/pdf';

                zoomInBtn.classList.toggle('hidden', !isImage);
                zoomOutBtn.classList.toggle('hidden', !isImage);

                if (isImage) {
                    const img = document.createElement('img');
                    img.src = doc.attachmentData;
                    img.alt = doc.attachmentName;
                    img.style.transform = `scale(${currentPreviewScale})`;
                    previewContent.appendChild(img);
                } else if (isPdf) {
                    const iframe = document.createElement('iframe');
                    iframe.src = doc.attachmentData;
                    previewContent.appendChild(iframe);
                } else {
                    previewContent.innerHTML = `<p style="text-align:center; padding:20px;">No direct preview available for this file type (${mimeType}). Please use the download button.</p>`;
                }

                downloadPreviewBtn.onclick = () => downloadAttachment(doc.id);
                previewModal.classList.add('active');
            }

            function closePreviewModal() {
                previewModal.classList.remove('active');
                previewContent.innerHTML = '';
                downloadPreviewBtn.onclick = null;
                currentPreviewScale = 1;
            }

            function zoomPreview(factor) {
                const previewElement = previewContent.querySelector('img');
                if (previewElement) {
                    currentPreviewScale = Math.max(0.1, currentPreviewScale + factor);
                    previewElement.style.transform = `scale(${currentPreviewScale})`;
                }
            }

            function toggleTheme() {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const newTheme = isDark ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem(LOCAL_STORAGE_KEY_THEME, newTheme);
                updateThemeIcons(newTheme);
                updateButtonLabel(newTheme);
            }

            function updateThemeIcons(theme) {
                moonIcon.classList.toggle('hidden', theme !== 'dark');
                sunIcon.classList.toggle('hidden', theme === 'dark');
            }

            function updateButtonLabel(theme) {
                const themeLabel = document.querySelector('.theme-label');
                const themeSwitcher = document.getElementById('theme-switcher');
                if (theme === 'dark') {
                    themeLabel.textContent = 'Light Mode';
                    themeSwitcher.setAttribute('aria-label', 'Activate light mode');
                } else {
                    themeLabel.textContent = 'Dark Mode';
                    themeSwitcher.setAttribute('aria-label', 'Activate dark mode');
                }
            }

            function createDocNameToAgencyMap() {
                for (const agency in documentNameOptions) {
                    for (const docName of documentNameOptions[agency]) {
                        if (docName !== 'Other') {
                            docNameToAgencyMap[docName] = agency;
                        }
                    }
                }
            }
            
            function initializeApp() {
                locations = loadDataFromLocalStorage(LOCAL_STORAGE_KEY_LOCATIONS);
                if (locations.length === 0) {
                    locations = PREDEFINED_LOCATIONS;
                    saveDataToLocalStorage(LOCAL_STORAGE_KEY_LOCATIONS, locations);
                }
                documents = loadDataFromLocalStorage(LOCAL_STORAGE_KEY_DOCUMENTS);
                archivedDocuments = loadDataFromLocalStorage(LOCAL_STORAGE_KEY_ARCHIVES);
                createDocNameToAgencyMap();
                
                const savedTheme = localStorage.getItem(LOCAL_STORAGE_KEY_THEME) || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                updateThemeIcons(savedTheme);
                updateButtonLabel(savedTheme);

                const isArchivedVisible = localStorage.getItem(LOCAL_STORAGE_KEY_ARCHIVE_VISIBILITY) === 'true';
                document.getElementById('archived-table-content').classList.toggle('hidden', !isArchivedVisible);

                const isAboutPanelExpanded = localStorage.getItem(LOCAL_STORAGE_KEY_ABOUT_PANEL_VISIBILITY) === 'true';
                aboutPanelContent.classList.toggle('expanded', isAboutPanelExpanded);
                toggleAboutPanelBtn.classList.toggle('rotated', isAboutPanelExpanded);
                aboutPanelHeader.setAttribute('aria-expanded', isAboutPanelExpanded);

                updateUI();
            }

            function openDeleteModal(docId) {
                sessionStorage.setItem('deletingDocId', docId);
                document.getElementById('deleteModal').classList.add('active');
            }
            
            function closeDeleteModal() {
                document.getElementById('deleteModal').classList.remove('active');
                sessionStorage.removeItem('deletingDocId');
            }

            function openDeleteAttachmentModal() {
                document.getElementById('deleteAttachmentModal').classList.add('active');
            }
            
            function closeDeleteAttachmentModal() {
                document.getElementById('deleteAttachmentModal').classList.remove('active');
            }
            
            function confirmDeleteAttachment() {
                document.getElementById('form-attachment-data').value = '';
                document.getElementById('form-attachment-name').value = '';
                document.getElementById('current-attachment').textContent = 'No file attached.';
                document.getElementById('deleteAttachmentBtn').classList.add('hidden');
                document.getElementById('form-upload-document').value = '';
                closeDeleteAttachmentModal();
                displayGlobalMessage('Attachment removed successfully!', 'success');
            }


            function confirmDelete() {
                const docId = sessionStorage.getItem('deletingDocId');
                if (docId) deleteDocument(docId);
                closeDeleteModal();
            }

            function highlightAndScrollToRow(docId) {
                const doc = documents.find(d => d.id === docId);
                if (!doc) return;

                locationSelect.value = doc.locationId;
                filterDocumentNameInput.value = doc.documentName;
                renderMainDocumentsTable();

                // Wait for table to render
                setTimeout(() => {
                    const rowToHighlight = documentsTableBody.querySelector(`[data-doc-id='${docId}']`);
                    if (rowToHighlight) {
                        manageDocumentsSection.scrollIntoView({ behavior: 'smooth' });
                        rowToHighlight.classList.add('row-highlight');
                        setTimeout(() => rowToHighlight.classList.remove('row-highlight'), 2500);
                    } else {
                        // Reset filter if not found
                        filterDocumentNameInput.value = '';
                        renderMainDocumentsTable();
                    }
                }, 100);
            }

            // --- Event Listeners ---

            document.getElementById('form-upload-document').addEventListener('change', (e) => {
                const fileInput = e.target;
                const file = fileInput.files[0];
                const currentAttachmentP = document.getElementById('current-attachment');
                if (file) {
                    if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                        displayGlobalMessage(`File is too large. Please select a file under ${MAX_FILE_SIZE_MB} MB.`, 'error');
                        fileInput.value = '';
                        return;
                    }
                    currentAttachmentP.textContent = `Selected: ${file.name}`;
                    document.getElementById('deleteAttachmentBtn').classList.remove('hidden');
                    document.getElementById('form-attachment-data').value = '';
                    document.getElementById('form-attachment-name').value = file.name;
                } else {
                    currentAttachmentP.textContent = 'No file attached.';
                    document.getElementById('deleteAttachmentBtn').classList.add('hidden');
                    document.getElementById('form-upload-document').value = '';
                    document.getElementById('form-attachment-data').value = '';
                    document.getElementById('form-attachment-name').value = '';
                }
            });


            document.getElementById('deleteAttachmentBtn').addEventListener('click', openDeleteAttachmentModal);
            document.getElementById('closeDeleteAttachmentModalBtn').addEventListener('click', closeDeleteAttachmentModal);
            document.getElementById('delete-attachment-cancel').addEventListener('click', closeDeleteAttachmentModal);
            document.getElementById('delete-attachment-confirm').addEventListener('click', confirmDeleteAttachment);


            document.getElementById('closeDeleteModalBtn').addEventListener('click', closeDeleteModal);
            document.getElementById('delete-cancel').addEventListener('click', closeDeleteModal);
            document.getElementById('delete-confirm').addEventListener('click', confirmDelete);

            
            [locationSelect, ...filterInputs].forEach(el => el.addEventListener('change', renderMainDocumentsTable));
            [filterAgencyNameInput, filterDocumentNameInput].forEach(el => el.addEventListener('input', renderMainDocumentsTable));
            [filterArchivedAgencyInput, filterArchivedDocumentInput, filterArchivedLocationSelect, filterArchivedYearSelect].forEach(el => el.addEventListener('input', renderArchivedDocumentsTable));
            [filterArchivedLocationSelect, filterArchivedYearSelect].forEach(el => el.addEventListener('change', renderArchivedDocumentsTable));
            
            addDocumentBtn.addEventListener('click', () => openDocumentModal());
            renewDocumentBtn.addEventListener('click', openRenewModal);
            
            documentForm.addEventListener('submit', handleSaveDocument);
            cancelDocumentBtn.addEventListener('click', closeDocumentModal);
            closeModalBtn.addEventListener('click', closeDocumentModal);
            documentModal.addEventListener('click', e => e.target === documentModal && closeDocumentModal()); 

            formAgencyNameSelect.addEventListener('change', (e) => {
                updateDocumentNameOptions(e.target.value);
                formAgencyNameOtherInput.classList.toggle('hidden', e.target.value !== 'Other');
                if(e.target.value === 'Other') formAgencyNameOtherInput.focus();
            });

            formDocumentNameSelect.addEventListener('change', (e) => {
                formDocumentNameOtherInput.classList.toggle('hidden', e.target.value !== 'Other');
                if(e.target.value === 'Other') formDocumentNameOtherInput.focus();
            });

            formLocationSelect.addEventListener('change', (e) => updateEntityNameOptions(e.target.value));

            formEntityNameSelect.addEventListener('change', (e) => {
                formEntityNameOtherInput.classList.toggle('hidden', e.target.value !== 'Other');
                if(e.target.value === 'Other') formEntityNameOtherInput.focus();
            });
            
            renewDocSelect.addEventListener('change', () => {
                renewConfirmBtn.disabled = !renewDocSelect.value;
                const selectedDoc = documents.find(d => d.id === renewDocSelect.value);
                renewLocationInfo.textContent = selectedDoc ? `Current Expiry: ${formatDate(selectedDoc.expirationDate)} at ${getLocationNameById(selectedDoc.locationId)}` : '';
            });
            
            renewConfirmBtn.addEventListener('click', () => {
                const selectedDocId = renewDocSelect.value;
                if (!selectedDocId) return displayGlobalMessage('Please select a document to renew.', 'error');
                
                if (window.confirm('Are you sure you want to renew this document?')) {
                    const docToRenew = documents.find(d => d.id === selectedDocId);
                    if (docToRenew) {
                        sessionStorage.setItem('renewingDocId', selectedDocId);
                        closeRenewModal();
                        openDocumentModal(docToRenew, true);
                    }
                }
            });
            renewCancelBtn.addEventListener('click', closeRenewModal);
            closeRenewModalBtn.addEventListener('click', closeRenewModal);
            renewModal.addEventListener('click', e => e.target === renewModal && closeRenewModal());
            
            documentsTableBody.addEventListener('click', e => {
                const target = e.target;
                const button = target.closest('button');
                const attachmentIndicator = target.closest('.attachment-indicator');

                // Handle attachment preview click
                if (attachmentIndicator) {
                    const docId = attachmentIndicator.dataset.id;
                    const doc = documents.find(d => d.id === docId);
                    if (doc && doc.attachmentData) openPreviewModal(doc);
                    else if (doc) displayGlobalMessage('No attachment available for this document.', 'info');
                    return;
                }

                if (!button) return; // Exit if the click was not on any button

                // Handle log status button click
                if (button.classList.contains('renewal-status-button')) {
                    const docId = button.dataset.docId;
                    const doc = documents.find(d => d.id === docId);
                    if (doc) {
                        openStatusLogModal(doc);
                    }
                    return;
                }
                
                // Handle disabled buttons
                if (button.disabled) return;

                // Handle Edit and Delete buttons
                const docId = button.dataset.id;
                if (button.classList.contains('delete-button-icon')) {
                    openDeleteModal(docId);
                } else if (button.classList.contains('edit-button-icon')) {
                    const docToEdit = documents.find(d => d.id === docId);
                    if (docToEdit) openDocumentModal(docToEdit);
                }
            });

            archivedDocumentsTableBody.addEventListener('click', e => {
                const attachmentIndicator = e.target.closest('.attachment-indicator');
                const logButton = e.target.closest('.view-log-btn');

                if (attachmentIndicator) {
                    const docId = attachmentIndicator.dataset.id;
                    const doc = archivedDocuments.find(d => d.id === docId);
                    if (doc && doc.attachmentData) {
                        openPreviewModal(doc);
                    } else if (doc) {
                        displayGlobalMessage('No attachment available for this document.', 'info');
                    }
                    return;
                }

                if (logButton) {
                    const docId = logButton.dataset.docId;
                    const doc = archivedDocuments.find(d => d.id === docId);
                    if (doc) {
                        openStatusLogModal(doc, true); // Open in read-only mode
                    }
                }
            });

            documentsTable.querySelector('thead').addEventListener('click', e => {
                const header = e.target.closest('th[data-sort-key]');
                if (header) {
                    const key = header.dataset.sortKey;
                    if (currentMainSortKey === key) {
                        currentMainSortDirection = currentMainSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentMainSortKey = key;
                        currentMainSortDirection = 'asc';
                    }
                    renderMainDocumentsTable();
                }
            });
            
            archivedDocumentsTable.querySelector('thead').addEventListener('click', e => {
                const header = e.target.closest('th[data-sort-key]');
                if (header) {
                    const key = header.dataset.sortKey;
                    if (currentArchivedSortKey === key) {
                        currentArchivedSortDirection = currentArchivedSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        currentArchivedSortKey = key;
                        currentArchivedSortDirection = 'asc';
                    }
                    renderArchivedDocumentsTable();
                }
            });

            themeSwitcher.addEventListener('click', toggleTheme);
            
            toggleArchivedTableBtn.addEventListener('click', () => {
                const container = document.getElementById('archived-table-content');
                const isHidden = container.classList.toggle('hidden');
                localStorage.setItem(LOCAL_STORAGE_KEY_ARCHIVE_VISIBILITY, !isHidden);
            });

            aboutPanelHeader.addEventListener('click', () => {
                const isExpanded = aboutPanelContent.classList.toggle('expanded');
                toggleAboutPanelBtn.classList.toggle('rotated', isExpanded);
                aboutPanelHeader.setAttribute('aria-expanded', isExpanded);
                localStorage.setItem(LOCAL_STORAGE_KEY_ABOUT_PANEL_VISIBILITY, isExpanded);
            });

            closePreviewModalBtn.addEventListener('click', closePreviewModal);
            previewModal.addEventListener('click', e => e.target === previewModal && closePreviewModal());
            zoomInBtn.addEventListener('click', () => zoomPreview(0.1));
            zoomOutBtn.addEventListener('click', () => zoomPreview(-0.1));

            document.querySelector('.compliance-dashboard').addEventListener('click', (e) => {
                const progressBarWrapper = e.target.closest('.progress-bar-container, .location-progress-bar');
                if (progressBarWrapper && progressBarWrapper.dataset.locationId !== 'overall') {
                    openComplianceDetailsModal(progressBarWrapper.dataset.locationId);
                }
            });

            closeComplianceModalBtn.addEventListener('click', closeComplianceDetailsModal);
            complianceDetailsModal.addEventListener('click', e => {
                 if (e.target === complianceDetailsModal) {
                    closeComplianceDetailsModal();
                    return;
                }
                const listItem = e.target.closest('li');
                if (!listItem || !listItem.dataset.docType) return;

                const { docId, docName, locationId, docType } = listItem.dataset;
                
                if (docType === 'compliant') {
                    closeComplianceDetailsModal();
                    highlightAndScrollToRow(docId);
                } else if (docType === 'lacking') {
                    const prefillData = {
                        documentName: docName,
                        locationId: locationId,
                        agencyName: docNameToAgencyMap[docName] || ''
                    };
                    closeComplianceDetailsModal();
                    openDocumentModal(null, false, prefillData);
                } else if (docType === 'expired' || docType === 'expiring') {
                    const docToRenew = documents.find(d => d.id === docId);
                    if (docToRenew) {
                        sessionStorage.setItem('renewingDocId', docId);
                        closeComplianceDetailsModal();
                        openDocumentModal(docToRenew, true);
                    }
                }
            });
			
			locationSortingControls.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                currentLocationSort = button.dataset.sortBy;
                
                locationSortingControls.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                renderLocationProgressBars();
            });
			
			documentsTableBody.addEventListener('click', e => {
                const logButton = e.target.closest('.log-status-btn');
                if (logButton) {
                    const docId = logButton.dataset.docId;
                    const doc = documents.find(d => d.id === docId);
                    if (doc) {
                        openStatusLogModal(doc);
                    }
                }
            });

            closeStatusLogModalBtn.addEventListener('click', closeStatusLogModal);
            statusLogModal.addEventListener('click', e => e.target === statusLogModal && closeStatusLogModal());

            newCommentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const docId = e.target.dataset.docId;
                const text = newCommentText.value.trim();
                const commentor = newCommentor.value.trim();

                if (!text || !commentor) {
                    displayGlobalMessage('Both comment and name are required.', 'error');
                    return;
                }

                const docIndex = documents.findIndex(d => d.id === docId);
                if (docIndex > -1) {
                    const newComment = {
                        timestamp: new Date().toISOString(),
                        text: text,
                        commentor: commentor
                    };
                    if (!documents[docIndex].comments) {
                        documents[docIndex].comments = [];
                    }
                    documents[docIndex].comments.push(newComment);
                    saveDataToLocalStorage(LOCAL_STORAGE_KEY_DOCUMENTS, documents);
                    
                    // Re-render the list inside the modal for immediate feedback
                    openStatusLogModal(documents[docIndex]);
                    newCommentForm.reset();
                    newCommentText.focus();
                }
            });
			
			notificationsList.addEventListener('click', (e) => {
                const listItem = e.target.closest('li.clickable');
                if (listItem && listItem.dataset.docId) {
                    const docId = listItem.dataset.docId;
                    const doc = documents.find(d => d.id === docId);
                    if (doc) {
                        openNotificationActionModal(doc);
                    }
                }
            });

            closeNotificationActionModalBtn.addEventListener('click', closeNotificationActionModal);
            notificationActionModal.addEventListener('click', e => e.target === notificationActionModal && closeNotificationActionModal());

            actionViewStatusBtn.addEventListener('click', (e) => {
                const docId = e.target.dataset.docId;
                const doc = documents.find(d => d.id === docId);
                if (doc) {
                    openStatusLogModal(doc);
                    statusLogModal.classList.add('modal-on-top'); // <-- ADD THIS LINE
                }
            });

            actionRenewBtn.addEventListener('click', (e) => {
                const docId = e.target.dataset.docId;
                const docToRenew = documents.find(d => d.id === docId);
                if (docToRenew) {
                    sessionStorage.setItem('renewingDocId', docId);
                    openDocumentModal(docToRenew, true);
                    documentModal.classList.add('modal-on-top'); // <-- ADD THIS LINE
                }
            });

            initializeApp();
			
			generateFullReportBtn.addEventListener('click', () => {
                const allLocationIds = locations.map(loc => loc.id);
                generateComplianceReport(allLocationIds);
            });

            generateReportBtn.addEventListener('click', (e) => {
                const locationId = e.target.closest('.modal-content').querySelector('h2').textContent.split(': ')[1];
                const loc = locations.find(l => l.name === locationId);
                if (loc) {
                    generateComplianceReport([loc.id]);
                }
            });
			
            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    if (documentModal.classList.contains('active')) closeDocumentModal();
                    if (renewModal.classList.contains('active')) closeRenewModal();
                    if (document.getElementById('deleteModal').classList.contains('active')) closeDeleteModal();
                    if (document.getElementById('deleteAttachmentModal').classList.contains('active')) closeDeleteAttachmentModal();
                    if (previewModal.classList.contains('active')) closePreviewModal();
                    if (complianceDetailsModal.classList.contains('active')) closeComplianceDetailsModal();
                }
            });

            if (addOneTimeCheckbox) {
                addOneTimeCheckbox.addEventListener('change', () => {
                    if (addOneTimeCheckbox.checked) {
                        addExpInput.disabled = true;
                        addExpInput.removeAttribute('required');
                        addExpInput.style.backgroundColor = '#eee';
                        addExpInput.style.color = '#666';
                        addExpInput.value = '';
                    } else {
                        addExpInput.disabled = false;
                        addExpInput.setAttribute('required', 'true');
                        addExpInput.style.backgroundColor = '';
                        addExpInput.style.color = '';
                    }
                });
            }
        });
    </script>

    <div id="deleteModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="delete-modal-title">
        <div class="modal-content">
            <button id="closeDeleteModalBtn" class="modal-close-btn" aria-label="Close modal">&times;</button>
            <h2 id="delete-modal-title" class="modal-title">Delete Document</h2>
            <p>Are you sure you want to permanently delete this document? This action cannot be undone.</p>
            <div class="flex-justify-between" style="margin-top: 1.5rem;">
                <button type="button" id="delete-cancel" style="color: black;">Cancel</button>
                <button type="button" id="delete-confirm" style="background-color: var(--color-danger); color: white;"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:0.9rem; height:0.9rem;"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> Remove</button>
            </div>
        </div>
    </div>

    <div id="deleteAttachmentModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="delete-attachment-modal-title">
        <div class="modal-content">
            <button id="closeDeleteAttachmentModalBtn" class="modal-close-btn" aria-label="Close modal">&times;</button>
            <h2 id="delete-attachment-modal-title" class="modal-title">Remove Attachment</h2>
            <p>Are you sure you want to remove the attached file? This action cannot be undone.</p>
            <div class="flex-justify-between" style="margin-top: 1.5rem;">
                <button type="button" id="delete-attachment-cancel" style="color: black;">Cancel</button>
                <button type="button" id="delete-attachment-confirm" style="background-color: var(--color-danger); color: white;">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width:1rem; height:1rem; margin-right:0.25rem; vertical-align:middle;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg> Remove
                </button>
            </div>
        </div>
    </div>

</body>
</html>